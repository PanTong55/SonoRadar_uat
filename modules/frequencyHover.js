import{getTimeExpansionMode}from"./fileState.js";export function initFrequencyHover({viewerId:e,wrapperId:t="viewer-wrapper",hoverLineId:n,hoverLineVId:o,freqLabelId:i,spectrogramHeight:l=800,spectrogramWidth:s=1024,maxFrequency:d=128,minFrequency:a=10,totalDuration:c=1e3,getZoomLevel:r,getDuration:u}){const m=document.getElementById(e),p=document.getElementById(t),h=document.getElementById(n),v=document.getElementById(o),f=document.getElementById(i),g=document.getElementById("fixed-overlay"),y=document.getElementById("zoom-controls"),E=document.getElementById("spectrogram-only"),x=[],w=[];let L=null,b=!0,C=!1;const T=()=>E.scrollWidth>m.clientWidth?0:20,F=5;let $=!1,B=!1,M=!1,k=!1,Y=!1,X=0,q=0,I=null,R=null,H=null,S=!1,z=0,N=null;m.addEventListener("force-hover-enable",(()=>{$=!1,Y=!1}));const G=()=>{h.style.display="none",v.style.display="none",f.style.display="none"},W=e=>{if(S=!0,R=e.clientX,H=e.clientY,$||M||Y)return void G();const t=m.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top,i=T();if(o>m.clientHeight-i)return G(),m.classList.remove("hide-cursor"),void(C=!0);C=!1,m.classList.add("hide-cursor");const s=m.scrollLeft||0,c=(1-o/l)*(d-a)+a,r=(n+s)/E.scrollWidth*u();h.style.top=`${o}px`,h.style.display="block",v.style.left=`${n}px`,v.style.display="block";let p;m.clientWidth-n<120?(f.style.transform="translate(-100%, -50%)",p=n-12+"px"):(f.style.transform="translate(0, -50%)",p=`${n+12}px`),f.style.top=`${o}px`,f.style.left=p,f.style.display="block";const g=getTimeExpansionMode(),y=g?1e3*r/10:1e3*r,x=Number((g?10*c:c).toFixed(1)).toString();f.textContent=`${x} kHz  ${y.toFixed(1)} ms`};m.addEventListener("mousemove",W,{passive:!0}),p.addEventListener("mouseleave",(()=>{S=!1,G()})),m.addEventListener("mouseenter",(()=>{m.classList.add("hide-cursor"),S=!0})),m.addEventListener("mouseleave",(()=>{m.classList.remove("hide-cursor"),S=!1}));const D=(e,t,n)=>Math.min(Math.max(e,t),n);y&&(y.addEventListener("mouseenter",(()=>{$=!0,G()})),y.addEventListener("mouseleave",(()=>{$=!1})));const P=document.getElementById("selection-time-info");function A(e,t,n){const o=m.getBoundingClientRect();if(X=e-o.left+m.scrollLeft,q=t-o.top,q>m.clientHeight-T())return;k=!0,$=!0,G(),I=document.createElement("div"),I.className="selection-rect",m.appendChild(I);const i="touch"===n?"touchmove":"mousemove",s="touch"===n?"touchend":"mouseup";let c=!1,p=0;const h=document.createElement("i");h.className="fa-solid fa-magnifying-glass selection-ctrl-icon",h.style.position="absolute",h.style.left="50%",h.style.top="50%",h.style.transform="translate(-50%, -50%)",h.style.pointerEvents="none",h.style.display="none",I.appendChild(h);const v=e=>{"Control"===e.key&&(c=!0,p>=100&&(h.style.display=""))},f=e=>{"Control"===e.key&&(c=!1,h.style.display="none")};window.addEventListener("keydown",v),window.addEventListener("keyup",f);const g=e=>{if(!k)return;const t=m.getBoundingClientRect(),o="touch"===n?e.touches[0].clientX:e.clientX,i="touch"===n?e.touches[0].clientY:e.clientY;let l=o-t.left+m.scrollLeft,s=i-t.top;l=D(l,0,m.scrollWidth),s=D(s,0,m.clientHeight-T());const d=Math.min(l,X),a=Math.abs(l-X),v=u()*r(),f=X/v*u()*1e3,g=l/v*u()*1e3;p=Math.abs(g-f),function(e,t){const n=getTimeExpansionMode(),o=Math.min(e,t),i=Math.max(e,t),l=i-o,s=n?o/10:o,d=n?i/10:i,a=n?l/10:l;P.textContent=`Selection time: ${s.toFixed(1)} - ${d.toFixed(1)} (${a.toFixed(1)}ms)`,P.style.display=""}(f,g);const y=Math.min(s,q),E=Math.abs(s-q);I.style.left=`${d}px`,I.style.top=`${y}px`,I.style.width=`${a}px`,I.style.height=`${E}px`;const x="touch"!==n&&!!e.ctrlKey;h.style.display=(x||c)&&p>=100?"":"none"},y=e=>{if(!k)return;k=!1,window.removeEventListener(i,g),window.removeEventListener(s,y),window.removeEventListener("keydown",v),window.removeEventListener("keyup",f),P.style.display="none";const t=I.getBoundingClientRect(),o=m.getBoundingClientRect(),p=t.left-o.left+m.scrollLeft,h=t.top-o.top,E=t.width,x=t.height;if(E<=3||x<=3){if(m.removeChild(I),window.removeEventListener("keydown",v),window.removeEventListener("keyup",f),I=null,$=!1,"touch"===n){const t=e.changedTouches?e.changedTouches[0].clientX:e.clientX,n=e.changedTouches?e.changedTouches[0].clientY:e.clientY;W({clientX:t,clientY:n})}else W(e);return}const b=(1-(h+x)/l)*(d-a)+a,C=(1-h/l)*(d-a)+a,T=u()*r(),B=p/T*u(),X=(p+E)/T*u(),q=function(e,t,n,o,i,s,c,p,h,v,f){const g={data:{startTime:v,endTime:f,Flow:s,Fhigh:i},rect:h,tooltip:null,expandBtn:null,closeBtn:null,btnGroup:null,durationLabel:null};1e3*p<=100&&(g.tooltip=j(g,e,t,n));const y=document.createElement("div");y.className="selection-duration";const E=getTimeExpansionMode()?1e3*p/10:1e3*p;y.textContent=`${E.toFixed(1)} ms`,h.appendChild(y),g.durationLabel=y,w.push(g),1e3*p>100&&O(g);return function(e){const t=e.rect;let n=!1,o=null,i=null;t.addEventListener("mousemove",(e=>{if(k||n)return;if(Y||e.target.closest(".selection-close-btn")||e.target.closest(".selection-expand-btn")||e.target.closest(".selection-fit-btn")||e.target.closest(".selection-btn-group"))return void(t.style.cursor="default");const o=t.getBoundingClientRect(),i=e.clientX-o.left,l=e.clientY-o.top;let s="default";const d=i<F,a=i>o.width-F,c=l<F,r=l>o.height-F;d&&c||a&&r?s="nwse-resize":a&&c||d&&r?s="nesw-resize":d||a?s="ew-resize":(c||r)&&(s="ns-resize"),t.style.cursor=s}),{passive:!0}),t.addEventListener("mousedown",(s=>{if(n)return;if(Y||s.target.closest(".selection-close-btn")||s.target.closest(".selection-expand-btn")||s.target.closest(".selection-fit-btn")||s.target.closest(".selection-btn-group"))return;const c=t.getBoundingClientRect(),p=s.clientX-c.left,h=s.clientY-c.top,v=p<F,f=p>c.width-F,g=h<F,y=h>c.height-F;if(o=v?"left":f?"right":null,i=g?"top":y?"bottom":null,!o&&!i)return;n=!0,M=!0,s.preventDefault();const E=t=>{if(!n)return;const s=m.getBoundingClientRect(),c=m.scrollLeft||0;let p=t.clientX-s.left+c,h=t.clientY-s.top;const v=u()*r(),f=d-a;if(p=Math.min(Math.max(p,0),v),h=Math.min(Math.max(h,0),l),"left"===o){let t=p/v*u();t=Math.min(t,e.data.endTime-.001),e.data.startTime=t}if("right"===o){let t=p/v*u();t=Math.max(t,e.data.startTime+.001),e.data.endTime=t}if("top"===i){let t=(1-h/l)*f+a;t=Math.max(t,e.data.Flow+.1),e.data.Fhigh=t}if("bottom"===i){let t=(1-h/l)*f+a;t=Math.min(t,e.data.Fhigh-.1),e.data.Flow=t}J()},x=()=>{n=!1,M=!1,o=null,i=null,window.removeEventListener("mousemove",E),window.removeEventListener("mouseup",x)};window.addEventListener("mousemove",E,{passive:!0}),window.addEventListener("mouseup",x)}))}(g),g.rect.addEventListener("mouseenter",(()=>{L=g})),g.rect.addEventListener("mouseleave",(e=>{const t=e.relatedTarget,n=t&&t.closest&&t.closest(".selection-btn-group");L!==g||n||(L=null)})),g}(p,h,E,0,C,b,0,X-B,I,B,X);if(I=null,$=!1,L=q,null!==R&&null!==H){const e=q.rect.getBoundingClientRect();R>=e.left&&R<=e.right&&H>=e.top&&H<=e.bottom&&(L=q)}const S=c||e&&e.ctrlKey,z=1e3*(q.data.endTime-q.data.startTime);S&&z>=100&&($=!1,Y=!1,m.dispatchEvent(new CustomEvent("expand-selection",{detail:{startTime:q.data.startTime,endTime:q.data.endTime}})),null!==R&&null!==H&&setTimeout((()=>{W({clientX:R,clientY:H})}),0),K(q))};window.addEventListener(i,g,{passive:"touch"!==n}),window.addEventListener(s,y)}function K(e){const t=w.indexOf(e);-1!==t&&(m.removeChild(w[t].rect),w[t].tooltip&&m.removeChild(w[t].tooltip),w.splice(t,1),L===e&&(L=null))}function j(e,t,n,o){const{Flow:i,Fhigh:l,startTime:s,endTime:d}=e.data,a=l-i,c=d-s,r=document.createElement("div");r.className="draggable-tooltip freq-tooltip",r.style.left=`${t+o+10}px`,r.style.top=`${n}px`;const u=getTimeExpansionMode(),p=u?10:1,h=l*p,v=i*p,f=a*p,g=1e3*c/(u?10:1),y=g>0?f/g:0;return r.innerHTML=`\n      <div><b>F.high:</b> <span class="fhigh">${h.toFixed(1)}</span> kHz</div>\n      <div><b>F.Low:</b> <span class="flow">${v.toFixed(1)}</span> kHz</div>\n      <div><b>Bandwidth:</b> <span class="bandwidth">${f.toFixed(1)}</span> kHz</div>\n      <div><b>Duration:</b> <span class="duration">${g.toFixed(1)}</span> ms</div>\n      <div><b>Avg.Slope:</b> <span class="slope">${y.toFixed(1)}</span> kHz/ms</div>\n      <div class="tooltip-close-btn">Ã—</div>\n    `,r.addEventListener("mouseenter",(()=>{B=!0,$=!0,G()})),r.addEventListener("mouseleave",(()=>{B=!1,$=!1})),r.querySelector(".tooltip-close-btn").addEventListener("click",(()=>{K(e),B=!1,$=!1})),m.appendChild(r),function(e){let t,n,o=!1;e.addEventListener("mousedown",(i=>{if(i.target.classList.contains("tooltip-close-btn"))return;o=!0;const l=e.getBoundingClientRect();t=i.clientX-l.left,n=i.clientY-l.top})),window.addEventListener("mousemove",(i=>{if(!o)return;const l=m.getBoundingClientRect(),s=i.clientX-l.left+m.scrollLeft-t,d=i.clientY-l.top-n;e.style.left=`${s}px`,e.style.top=`${d}px`}),{passive:!0}),window.addEventListener("mouseup",(()=>{o=!1}))}(r),requestAnimationFrame((()=>Z(e,t,n,o))),r}function O(e){const t=document.createElement("div");t.className="selection-btn-group";const n=document.createElement("i");n.className="fa-solid fa-xmark selection-close-btn",n.title="Close selection",n.addEventListener("click",(t=>{t.stopPropagation(),K(e),$=!1,Y=!1,null!==R&&null!==H&&W({clientX:R,clientY:H})})),n.addEventListener("mousedown",(e=>{e.stopPropagation()})),n.addEventListener("mouseenter",(()=>{$=!0,G()})),n.addEventListener("mouseleave",(()=>{$=!1}));const o=document.createElement("i");o.className="fa-solid fa-arrows-left-right-to-line selection-expand-btn",o.title="Crop and expand this session",o.addEventListener("click",(t=>{t.stopPropagation(),$=!1,Y=!1,m.dispatchEvent(new CustomEvent("expand-selection",{detail:{startTime:e.data.startTime,endTime:e.data.endTime}})),null!==R&&null!==H&&setTimeout((()=>{W({clientX:R,clientY:H})}),0)})),o.addEventListener("mouseenter",(()=>{$=!0,G()})),o.addEventListener("mouseleave",(()=>{$=!1}));const i=document.createElement("i");i.className="fa-solid fa-up-right-and-down-left-from-center selection-fit-btn",i.title="Fit to window",i.addEventListener("click",(t=>{t.stopPropagation(),m.dispatchEvent(new CustomEvent("fit-window-selection",{detail:{startTime:e.data.startTime,endTime:e.data.endTime,Flow:e.data.Flow,Fhigh:e.data.Fhigh}})),$=!1,Y=!1})),i.addEventListener("mouseenter",(()=>{$=!0,G()})),i.addEventListener("mouseleave",(()=>{$=!1})),t.addEventListener("mouseenter",(()=>{Y=!0,null!==R&&null!==H?W({clientX:R,clientY:H}):G(),e.rect.style.cursor="default",L=e})),t.addEventListener("mouseleave",(e=>{Y=!1;const t=e.relatedTarget,n=t&&t.closest&&t.closest(".selection-rect"),o=t&&t.closest&&t.closest(".selection-btn-group");n||o||(L=null)})),t.addEventListener("mousedown",(e=>{e.stopPropagation()})),t.appendChild(n),t.appendChild(o),t.appendChild(i),e.rect.appendChild(t),e.btnGroup=t,e.closeBtn=n,e.expandBtn=o,e.fitBtn=i,V(e)}function V(e){if(!e.btnGroup)return;const t=e.btnGroup;t.style.left="",t.style.right="-35px";const n=t.getBoundingClientRect(),o=E.getBoundingClientRect();n.right>o.right&&(t.style.right="auto",t.style.left="-35px")}function Z(e,t,n,o){if(!e.tooltip)return;const i=e.tooltip,l=i.offsetWidth;let s=t+o+10;s+l>(m.scrollLeft||0)+m.clientWidth&&(s=t-l-10),i.style.left=`${s}px`,i.style.top=`${n}px`}function J(){const e=u()*r(),t=d-a;w.forEach((n=>{const{startTime:o,endTime:i,Flow:s,Fhigh:d}=n.data,c=o/u()*e,r=(i-o)/u()*e,p=(1-(d-a)/t)*l,h=(d-s)/t*l;n.rect.style.left=`${c}px`,n.rect.style.top=`${p}px`,n.rect.style.width=`${r}px`,n.rect.style.height=`${h}px`;1e3*(i-o)<=100?(n.btnGroup&&(n.btnGroup.style.display="none"),n.tooltip||(n.tooltip=j(n,c,p,r))):(n.tooltip&&(m.removeChild(n.tooltip),n.tooltip=null),n.btnGroup?n.btnGroup.style.display="":O(n)),Z(n,c,p,r),function(e,t,n,o,i){const{data:l,tooltip:s}=e,d=l.Flow,a=l.Fhigh,c=a-d,r=l.endTime-l.startTime,u=getTimeExpansionMode(),m=u?10:1,p=a*m,h=d*m,v=c*m,f=1e3*r/(u?10:1),g=f>0?v/f:0;s?(e.durationLabel&&(e.durationLabel.textContent=`${f.toFixed(1)} ms`),s.querySelector(".fhigh").textContent=p.toFixed(1),s.querySelector(".flow").textContent=h.toFixed(1),s.querySelector(".bandwidth").textContent=v.toFixed(1),s.querySelector(".duration").textContent=f.toFixed(1),s.querySelector(".slope").textContent=g.toFixed(1)):e.durationLabel&&(e.durationLabel.textContent=`${f.toFixed(1)} ms`)}(n),V(n)}))}return m.addEventListener("mousedown",(e=>{B||M||0===e.button&&A(e.clientX,e.clientY,"mouse")})),m.addEventListener("touchstart",(e=>{if(B||M)return;if(1!==e.touches.length)return;const t=Date.now();t-z<300?(clearTimeout(N),e.preventDefault(),A(e.touches[0].clientX,e.touches[0].clientY,"touch")):(z=t,N=setTimeout((()=>{z=0}),300))})),m.addEventListener("contextmenu",(e=>{if(!b||C||B)return;if(e.target.closest(".selection-expand-btn")||e.target.closest(".selection-fit-btn")||e.target.closest(".selection-btn-group"))return;e.preventDefault();const t=g.getBoundingClientRect(),n=(1-(e.clientY-t.top)/l)*(d-a)+a,o=x.findIndex((e=>Math.abs(e.freq-n)<1));if(-1!==o)g.removeChild(x[o].div),x.splice(o,1);else{if(x.length>=5)return;const e=Math.round((1-(n-a)/(d-a))*l),t=document.createElement("div");t.className="persistent-line",t.style.top=`${e}px`,g.appendChild(t),x.push({freq:n,div:t})}})),{updateSelections:J,clearSelections:function(){w.forEach((e=>{m.removeChild(e.rect),e.tooltip&&m.removeChild(e.tooltip)})),w.length=0,L=null},setFrequencyRange:(e,t)=>{a=e,d=t,J()},hideHover:G,refreshHover:()=>{null!==R&&null!==H&&S&&W({clientX:R,clientY:H})},setPersistentLinesEnabled:e=>{b=e},getHoveredSelection:()=>w.includes(L)?L:null}}