function asyncGeneratorStep(t,e,s,r,i,a,n){try{var h=t[a](n),o=h.value}catch(t){return void s(t)}h.done?e(o):Promise.resolve(o).then(r,i)}function _asyncToGenerator(t){return function(){var e=this,s=arguments;return new Promise((function(r,i){var a=t.apply(e,s);function n(t){asyncGeneratorStep(a,r,i,n,h,"next",t)}function h(t){asyncGeneratorStep(a,r,i,n,h,"throw",t)}n(void 0)}))}}class EventEmitter{constructor(){this.listeners={}}on(t,e,s){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(e),s?.once){const s=()=>{this.un(t,s),this.un(t,e)};return this.on(t,s),s}return()=>this.un(t,e)}un(t,e){this.listeners[t]?.delete(e)}once(t,e){return this.on(t,e,{once:!0})}unAll(){this.listeners={}}emit(t,...e){this.listeners[t]?.forEach((t=>t(...e)))}}class BasePlugin extends EventEmitter{constructor(t){super(),this.subscriptions=[],this.options=t}onInit(){}_init(t){this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((t=>t()))}}function createElement(t,e,s){const r=e?.xmlns?document.createElementNS(e.xmlns,t):document.createElement(t);for(const[t,s]of Object.entries(e||{}))if("children"===t)for(const[t,s]of Object.entries(e.children||{}))"string"==typeof s?r.appendChild(document.createTextNode(s)):r.appendChild(createElement(t,s));else"style"===t?Object.assign(r.style,s):"textContent"===t?r.textContent=s:r.setAttribute(t,String(s));return s&&s.appendChild(r),r}function FFT(t,e,s,r){switch(this.bufferSize=t,this.sampleRate=e,this.bandwidth=2/t*(e/2),this.sinTable=new Float32Array(t),this.cosTable=new Float32Array(t),this.windowValues=new Float32Array(t),this.reverseTable=new Uint32Array(t),this.peakBand=0,this.peak=0,s){case"bartlett":for(i=0;i<t;i++)this.windowValues[i]=2/(t-1)*((t-1)/2-Math.abs(i-(t-1)/2));break;case"bartlettHann":for(i=0;i<t;i++)this.windowValues[i]=.62-.48*Math.abs(i/(t-1)-.5)-.38*Math.cos(2*Math.PI*i/(t-1));break;case"blackman":for(r=r||.16,i=0;i<t;i++)this.windowValues[i]=(1-r)/2-.5*Math.cos(2*Math.PI*i/(t-1))+r/2*Math.cos(4*Math.PI*i/(t-1));break;case"cosine":for(i=0;i<t;i++)this.windowValues[i]=Math.cos(Math.PI*i/(t-1)-Math.PI/2);break;case"gauss":for(r=r||.25,i=0;i<t;i++)this.windowValues[i]=Math.pow(Math.E,-.5*Math.pow((i-(t-1)/2)/(r*(t-1)/2),2));break;case"hamming":for(i=0;i<t;i++)this.windowValues[i]=.54-.46*Math.cos(2*Math.PI*i/(t-1));break;case"hann":case void 0:for(i=0;i<t;i++)this.windowValues[i]=.5*(1-Math.cos(2*Math.PI*i/(t-1)));break;case"lanczoz":for(i=0;i<t;i++)this.windowValues[i]=Math.sin(Math.PI*(2*i/(t-1)-1))/(Math.PI*(2*i/(t-1)-1));break;case"rectangular":for(i=0;i<t;i++)this.windowValues[i]=1;break;case"triangular":for(i=0;i<t;i++)this.windowValues[i]=2/t*(t/2-Math.abs(i-(t-1)/2));break;default:throw Error("No such window function '"+s+"'")}for(var i,a=1,n=t>>1;a<t;){for(i=0;i<a;i++)this.reverseTable[i+a]=this.reverseTable[i]+n;a<<=1,n>>=1}for(i=0;i<t;i++)this.sinTable[i]=Math.sin(-Math.PI/i),this.cosTable[i]=Math.cos(-Math.PI/i);this.calculateSpectrum=function(t){var e,s,r=this.bufferSize,i=this.cosTable,a=this.sinTable,n=this.reverseTable,h=new Float32Array(r),o=new Float32Array(r),l=2/this.bufferSize,c=Math.sqrt,u=new Float32Array(r/2),f=Math.floor(Math.log(r)/Math.LN2);if(Math.pow(2,f)!==r)throw"Invalid buffer size, must be a power of 2.";if(r!==t.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+r+" Buffer Size: "+t.length;const p=this.windowValues;for(var d=0;d<r;d++){const e=n[d];h[d]=t[e]*p[e],o[d]=0}for(var b,w,g,M,m,y,T,z,k=1;k<r;){b=i[k],w=a[k],g=1,M=0;for(var v=0;v<k;v++){for(d=v;d<r;)y=g*h[m=d+k]-M*o[m],T=g*o[m]+M*h[m],h[m]=h[d]-y,o[m]=o[d]-T,h[d]+=y,o[d]+=T,d+=k<<1;g=(z=g)*b-M*w,M=z*w+M*b}k<<=1}const F=r/2;for(d=0;d<F;d++)e=h[d],s=o[d],u[d]=l*c(e*e+s*s);return u}}const ERB_A=1e3*Math.log(10)/107.939;class SpectrogramPlugin extends BasePlugin{static create(t){return new SpectrogramPlugin(t||{})}constructor(t){if(super(t),this.frequenciesDataUrl=t.frequenciesDataUrl,this.container="string"==typeof t.container?document.querySelector(t.container):t.container,t.colorMap&&"string"!=typeof t.colorMap){if(t.colorMap.length<256)throw new Error("Colormap must contain 256 elements");for(let e=0;e<t.colorMap.length;e++)if(4!==t.colorMap[e].length)throw new Error("ColorMap entries must contain 4 values");this.colorMap=t.colorMap}else switch(this.colorMap=t.colorMap||"roseus",this.colorMap){case"gray":this.colorMap=[];for(let t=0;t<256;t++){const e=(255-t)/256;this.colorMap.push([e,e,e,1])}break;case"igray":this.colorMap=[];for(let t=0;t<256;t++){const e=t/256;this.colorMap.push([e,e,e,1])}break;case"roseus":this.colorMap=[[.004528,.004341,.004307,1],[.005625,.006156,.00601,1],[.99793,.983217,.97692,1]];break;default:throw Error("No such colormap '"+this.colorMap+"'")}this.fftSamples=t.fftSamples||512,this.height=t.height||200,this.noverlap=t.noverlap||null,this.windowFunc=t.windowFunc||"hann",this.alpha=t.alpha,this.frequencyMin=t.frequencyMin||0,this.frequencyMax=t.frequencyMax||0,this.gainDB=t.gainDB??20,this.rangeDB=t.rangeDB??80,this.scale=t.scale||"mel",this.numMelFilters=this.fftSamples/2,this.numLogFilters=this.fftSamples/2,this.numBarkFilters=this.fftSamples/2,this.numErbFilters=this.fftSamples/2,this.createWrapper(),this.createCanvas()}onInit(){this.container=this.container||this.wavesurfer.getWrapper(),this.container.appendChild(this.wrapper),this.wavesurfer.options.fillParent&&Object.assign(this.wrapper.style,{width:"100%",overflowX:"hidden",overflowY:"hidden"}),this.subscriptions.push(this.wavesurfer.on("redraw",(()=>this.render())))}destroy(){this.unAll(),this.wavesurfer.un("ready",this._onReady),this.wavesurfer.un("redraw",this._onRender),this.buffer=void 0,this.frequencies=void 0,this.wavesurfer=null,this.util=null,this.options=null,this.wrapper&&(this.wrapper.remove(),this.wrapper=null),super.destroy()}loadFrequenciesData(t){return _asyncToGenerator((function*(){const e=yield fetch(t);if(!e.ok)throw new Error("Unable to fetch frequencies data");const s=yield e.json();this.frequencies=s,this.drawSpectrogram(s)})).call(this)}createWrapper(){this.wrapper=createElement("div",{style:{display:"block",position:"relative",userSelect:"none"}}),this.options.labels&&(this.labelsEl=createElement("canvas",{part:"spec-labels",style:{position:"absolute",zIndex:9,width:"55px",height:"100%"}},this.wrapper)),this.wrapper.addEventListener("click",this._onWrapperClick)}createCanvas(){this.canvas=createElement("canvas",{style:{position:"absolute",left:0,top:0,width:"100%",height:"100%",zIndex:4}},this.wrapper),this.spectrCc=this.canvas.getContext("2d")}render(){if(this.frequenciesDataUrl)this.loadFrequenciesData(this.frequenciesDataUrl);else{const t=this.wavesurfer?.getDecodedData();t&&(this.frequencies&&this.buffer===t||(this.frequencies=this.getFrequencies(t)),this.drawSpectrogram(this.frequencies))}}drawSpectrogram(t){isNaN(t[0][0])||(t=[t]),this.wrapper.style.height=this.height*t.length+"px",this.canvas.width=this.getWidth(),this.canvas.height=this.height*t.length;const e=this.spectrCc,s=this.height,r=this.getWidth(),i=this.buffer.sampleRate/2,a=this.frequencyMin,n=this.frequencyMax;if(e){if(n>i){const i=this.colorMap[this.colorMap.length-1];e.fillStyle=`rgba(${i[0]}, ${i[1]}, ${i[2]}, ${i[3]})`,e.fillRect(0,0,r,s*t.length)}for(let h=0;h<t.length;h++){const o=this.resample(t[h]),l=o[0].length,c=new ImageData(r,l),u=c.data,f=new Uint8ClampedArray(1024);for(let t=0;t<256;t++){const e=this.colorMap[t],s=4*t;f[s]=Math.round(255*e[0]),f[s+1]=Math.round(255*e[1]),f[s+2]=Math.round(255*e[2]),f[s+3]=Math.round(255*e[3])}for(let t=0;t<o.length;t++)for(let e=0;e<o[t].length;e++){const s=4*o[t][e],i=4*((l-e-1)*r+t);u[i]=f[s],u[i+1]=f[s+1],u[i+2]=f[s+2],u[i+3]=f[s+3]}const p=this.hzToScale(a)/this.hzToScale(i),d=this.hzToScale(n)/this.hzToScale(i),b=Math.min(1,d);createImageBitmap(c,0,Math.round(l*(1-b)),r,Math.round(l*(b-p))).then((t=>{e.drawImage(t,0,s*(h+1-b/d),r,s*b/d)}))}this.options.labels&&this.loadLabels(this.options.labelsBackground,"12px","12px","",this.options.labelsColor,this.options.labelsHzColor||this.options.labelsColor,"center","#specLabels",t.length),this.emit("ready")}}createFilterBank(t,e,s,r){const i=s(0),a=s(e/2),n=e/this.fftSamples,h=this.fftSamples/2,o=a-i,l=1/t,c=[];for(let e=0;e<t;e++){const t=new Array(h+1).fill(0);let s=r(i+e*l*o),a=Math.floor(s/n),u=a*n,f=(s-u)/((a+1)*n-u);t[a]=1-f,t[a+1]=f,c[e]=t}return c}hzToMel(t){return 2595*Math.log10(1+t/700)}melToHz(t){return 700*(Math.pow(10,t/2595)-1)}createMelFilterBank(t,e){return this.createFilterBank(t,e,this.hzToMel.bind(this),this.melToHz.bind(this))}hzToLog(t){return Math.log10(Math.max(1,t))}logToHz(t){return Math.pow(10,t)}createLogFilterBank(t,e){return this.createFilterBank(t,e,this.hzToLog.bind(this),this.logToHz.bind(this))}hzToBark(t){let e=26.81*t/(1960+t)-.53;return e<2&&(e+=.15*(2-e)),e>20.1&&(e+=.22*(e-20.1)),e}barkToHz(t){return t<2&&(t=(t-.3)/.85),t>20.1&&(t=(t+4.422)/1.22),(t+.53)/(26.28-t)*1960}createBarkFilterBank(t,e){return this.createFilterBank(t,e,this.hzToBark.bind(this),this.barkToHz.bind(this))}hzToErb(t){return ERB_A*Math.log10(1+.00437*t)}erbToHz(t){return(Math.pow(10,t/ERB_A)-1)/.00437}createErbFilterBank(t,e){return this.createFilterBank(t,e,this.hzToErb.bind(this),this.erbToHz.bind(this))}hzToScale(t){switch(this.scale){case"mel":return this.hzToMel(t);case"logarithmic":return this.hzToLog(t);case"bark":return this.hzToBark(t);case"erb":return this.hzToErb(t)}return t}scaleToHz(t){switch(this.scale){case"mel":return this.melToHz(t);case"logarithmic":return this.logToHz(t);case"bark":return this.barkToHz(t);case"erb":return this.erbToHz(t)}return t}applyFilterBank(t,e){const s=e.length,r=Float32Array.from({length:s},(()=>0));for(let i=0;i<s;i++)for(let s=0;s<t.length;s++)r[i]+=t[s]*e[i][s];return r}getWidth(){return this.wavesurfer.getWrapper().offsetWidth}getFrequencies(t){const e=this.fftSamples,s=this.options.splitChannels??this.wavesurfer?.options.splitChannels?t.numberOfChannels:1;if(this.frequencyMax=this.frequencyMax||t.sampleRate/2,!t)return;this.buffer=t;const r=t.sampleRate,i=[];let a=this.noverlap;if(!a){const s=t.length/this.canvas.width;a=Math.max(0,Math.round(e-s))}const n=new FFT(e,r,this.windowFunc,this.alpha);let h;switch(this.scale){case"mel":h=this.createFilterBank(this.numMelFilters,r,this.hzToMel.bind(this),this.melToHz.bind(this));break;case"logarithmic":h=this.createFilterBank(this.numLogFilters,r,this.hzToLog.bind(this),this.logToHz.bind(this));break;case"bark":h=this.createFilterBank(this.numBarkFilters,r,this.hzToBark.bind(this),this.barkToHz.bind(this));break;case"erb":h=this.createFilterBank(this.numErbFilters,r,this.hzToErb.bind(this),this.erbToHz.bind(this))}const o=e/2,l=-this.gainDB,c=l-this.rangeDB,u=255/this.rangeDB;for(let r=0;r<s;r++){const s=t.getChannelData(r),f=[];let p=0;for(;p+e<s.length;){const t=s.slice(p,p+e),r=new Uint8Array(o);let i=n.calculateSpectrum(t);h&&(i=this.applyFilterBank(i,h));for(let t=0;t<o;t++){const e=i[t]>1e-12?i[t]:1e-12,s=20*Math.log10(e);r[t]=s<c?0:s>l?255:(s+this.gainDB)*u+256}f.push(r),p+=e-a}i.push(f)}return this.frequencies=i,i}freqType(t){return t>=1e3?(t/1e3).toFixed(1):Math.round(t)}unitType(t){return t>=1e3?"kHz":"Hz"}getLabelFrequency(t,e){const s=this.hzToScale(this.frequencyMin),r=this.hzToScale(this.frequencyMax);return this.scaleToHz(s+t/e*(r-s))}loadLabels(t,e,s,r,i,a,n,h,o){t=t||"rgba(68,68,68,0)",e=e||"12px",s=s||"12px",r=r||"Helvetica",i=i||"#fff",a=a||"#fff",n=n||"center",h=h||"#specLabels";const l=this.height||512,c=l/256*5,u=this.labelsEl.getContext("2d"),f=window.devicePixelRatio;if(this.labelsEl.height=this.height*o*f,this.labelsEl.width=55*f,u.scale(f,f),!u)return;const p=e+" "+r,d=s+" "+r,b=1/c;for(let e=0;e<o;e++){u.fillStyle=t,u.fillRect(0,e*l,55,(1+e)*l),u.fill(),u.textAlign=n,u.textBaseline="middle";for(let t=0;t<=c;t++){const s=this.getLabelFrequency(t,c),r=this.freqType(s),n=this.unitType(s),h=16;let o=(1+e)*l-t*b*l;o=Math.min(Math.max(o,e*l+10),(1+e)*l-10),u.fillStyle=a,u.font=d,u.fillText(n,h+24,o),u.fillStyle=i,u.font=p,u.fillText(r,h,o)}}}resample(t){const e=this.getWidth(),s=[],r=t.length,i=t[0].length,a=1/r,n=1/e,h=new Float32Array(i);for(let o=0;o<e;o++){h.fill(0);const e=o*n,l=e+n;for(let s=0;s<r;s++){const r=s*a,o=r+a,c=Math.max(0,Math.min(o,l)-Math.max(r,e));if(c>0){const e=c/n,r=t[s];for(let t=0;t<i;t++)h[t]+=e*r[t]}}const c=new Uint8Array(i);for(let t=0;t<i;t++)c[t]=h[t];s.push(c)}return s}}export default SpectrogramPlugin;