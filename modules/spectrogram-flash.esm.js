function asyncGeneratorStep(t,e,s,i,r,a,n){try{var h=t[a](n),o=h.value}catch(t){return void s(t)}h.done?e(o):Promise.resolve(o).then(i,r)}function _asyncToGenerator(t){return function(){var e=this,s=arguments;return new Promise((function(i,r){var a=t.apply(e,s);function n(t){asyncGeneratorStep(a,i,r,n,h,"next",t)}function h(t){asyncGeneratorStep(a,i,r,n,h,"throw",t)}n(void 0)}))}}class EventEmitter{constructor(){this.listeners={}}on(t,e,s){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(e),s?.once){const s=()=>{this.un(t,s),this.un(t,e)};return this.on(t,s),s}return()=>this.un(t,e)}un(t,e){this.listeners[t]?.delete(e)}once(t,e){return this.on(t,e,{once:!0})}unAll(){this.listeners={}}emit(t,...e){this.listeners[t]?.forEach((t=>t(...e)))}}class BasePlugin extends EventEmitter{constructor(t){super(),this.subscriptions=[],this.options=t}onInit(){}_init(t){this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((t=>t()))}}function createElement(t,e,s){const i=e?.xmlns?document.createElementNS(e.xmlns,t):document.createElement(t);for(const[t,s]of Object.entries(e||{}))if("children"===t)for(const[t,s]of Object.entries(e.children||{}))"string"==typeof s?i.appendChild(document.createTextNode(s)):i.appendChild(createElement(t,s));else"style"===t?Object.assign(i.style,s):"textContent"===t?i.textContent=s:i.setAttribute(t,String(s));return s&&s.appendChild(i),i}function FFT(t,e,s,i){switch(this.bufferSize=t,this.sampleRate=e,this.bandwidth=2/t*(e/2),this.sinTable=new Float32Array(t),this.cosTable=new Float32Array(t),this.windowValues=new Float32Array(t),this.reverseTable=new Uint32Array(t),this.peakBand=0,this.peak=0,this._real=new Float32Array(t),this._imag=new Float32Array(t),s){case"bartlett":for(r=0;r<t;r++)this.windowValues[r]=2/(t-1)*((t-1)/2-Math.abs(r-(t-1)/2));break;case"bartlettHann":for(r=0;r<t;r++)this.windowValues[r]=.62-.48*Math.abs(r/(t-1)-.5)-.38*Math.cos(2*Math.PI*r/(t-1));break;case"blackman":for(i=i||.16,r=0;r<t;r++)this.windowValues[r]=(1-i)/2-.5*Math.cos(2*Math.PI*r/(t-1))+i/2*Math.cos(4*Math.PI*r/(t-1));break;case"cosine":for(r=0;r<t;r++)this.windowValues[r]=Math.cos(Math.PI*r/(t-1)-Math.PI/2);break;case"gauss":for(i=i||.25,r=0;r<t;r++)this.windowValues[r]=Math.pow(Math.E,-.5*Math.pow((r-(t-1)/2)/(i*(t-1)/2),2));break;case"hamming":for(r=0;r<t;r++)this.windowValues[r]=.54-.46*Math.cos(2*Math.PI*r/(t-1));break;case"hann":case void 0:for(r=0;r<t;r++)this.windowValues[r]=.5*(1-Math.cos(2*Math.PI*r/(t-1)));break;case"lanczoz":for(r=0;r<t;r++)this.windowValues[r]=Math.sin(Math.PI*(2*r/(t-1)-1))/(Math.PI*(2*r/(t-1)-1));break;case"rectangular":for(r=0;r<t;r++)this.windowValues[r]=1;break;case"triangular":for(r=0;r<t;r++)this.windowValues[r]=2/t*(t/2-Math.abs(r-(t-1)/2));break;default:throw Error("No such window function '"+s+"'")}for(var r,a=1,n=t>>1;a<t;){for(r=0;r<a;r++)this.reverseTable[r+a]=this.reverseTable[r]+n;a<<=1,n>>=1}for(r=0;r<t;r++)this.sinTable[r]=Math.sin(-Math.PI/r),this.cosTable[r]=Math.cos(-Math.PI/r);this.calculateSpectrum=function(t){var e,s,i=this.bufferSize,r=this.cosTable,a=this.sinTable,n=this.reverseTable,h=this._real,o=this._imag,l=2/this.bufferSize,c=Math.sqrt,u=new Float32Array(i/2),f=Math.floor(Math.log(i)/Math.LN2);if(Math.pow(2,f)!==i)throw"Invalid buffer size, must be a power of 2.";if(i!==t.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+i+" Buffer Size: "+t.length;const p=this.windowValues;for(var d=0;d<i;d++){const e=n[d];h[d]=t[e]*p[e],o[d]=0}for(var b,g,w,M,m,k,y,T,v=1;v<i;){b=r[v],g=a[v],w=1,M=0;for(var z=0;z<v;z++){for(d=z;d<i;)k=w*h[m=d+v]-M*o[m],y=w*o[m]+M*h[m],h[m]=h[d]-k,o[m]=o[d]-y,h[d]+=k,o[d]+=y,d+=v<<1;w=(T=w)*b-M*g,M=T*g+M*b}v<<=1}const B=i>>1;for(d=0;d<B;d++)e=h[d],s=o[d],u[d]=l*c(e*e+s*s);return u}}const ERB_A=1e3*Math.log(10)/107.939;class SpectrogramPlugin extends BasePlugin{static create(t){return new SpectrogramPlugin(t||{})}constructor(t){if(super(t),this.frequenciesDataUrl=t.frequenciesDataUrl,this.container="string"==typeof t.container?document.querySelector(t.container):t.container,t.colorMap&&"string"!=typeof t.colorMap){if(t.colorMap.length<256)throw new Error("Colormap must contain 256 elements");for(let e=0;e<t.colorMap.length;e++)if(4!==t.colorMap[e].length)throw new Error("ColorMap entries must contain 4 values");this.colorMap=t.colorMap}else switch(this.colorMap=t.colorMap||"roseus",this.colorMap){case"gray":this.colorMap=[];for(let t=0;t<256;t++){const e=(255-t)/256;this.colorMap.push([e,e,e,1])}break;case"igray":this.colorMap=[];for(let t=0;t<256;t++){const e=t/256;this.colorMap.push([e,e,e,1])}break;case"roseus":this.colorMap=[[.004528,.004341,.004307,1],[.005625,.006156,.00601,1],[.99793,.983217,.97692,1]];break;default:throw Error("No such colormap '"+this.colorMap+"'")}this.fftSamples=t.fftSamples||512,this.height=t.height||200,this.noverlap=t.noverlap||null,this.windowFunc=t.windowFunc||"hann",this.alpha=t.alpha,this.frequencyMin=t.frequencyMin||0,this.frequencyMax=t.frequencyMax||0,this.gainDB=t.gainDB??20,this.rangeDB=t.rangeDB??80,this.scale=t.scale||"mel",this.numMelFilters=this.fftSamples/2,this.numLogFilters=this.fftSamples/2,this.numBarkFilters=this.fftSamples/2,this.numErbFilters=this.fftSamples/2,this.createWrapper(),this.createCanvas(),this._fft=null,this._filterBankCache=new Map,this._offscreenCanvas=document.createElement("canvas"),this._colorCache=null}onInit(){this.container=this.container||this.wavesurfer.getWrapper(),this.container.appendChild(this.wrapper),this.wavesurfer.options.fillParent&&Object.assign(this.wrapper.style,{width:"100%",overflowX:"hidden",overflowY:"hidden"}),this.subscriptions.push(this.wavesurfer.on("redraw",(()=>this.render())))}destroy(){this.unAll(),this.wavesurfer.un("ready",this._onReady),this.wavesurfer.un("redraw",this._onRender),this.buffer=void 0,this.frequencies=void 0,this.wavesurfer=null,this.util=null,this.options=null,this.wrapper&&(this.wrapper.remove(),this.wrapper=null),super.destroy()}loadFrequenciesData(t){return _asyncToGenerator((function*(){const e=yield fetch(t);if(!e.ok)throw new Error("Unable to fetch frequencies data");const s=yield e.json();this.frequencies=s,this.drawSpectrogram(s)})).call(this)}createWrapper(){this.wrapper=createElement("div",{style:{display:"block",position:"relative",userSelect:"none"}}),this.options.labels&&(this.labelsEl=createElement("canvas",{part:"spec-labels",style:{position:"absolute",zIndex:9,width:"55px",height:"100%"}},this.wrapper)),this.wrapper.addEventListener("click",this._onWrapperClick)}createCanvas(){this.canvas=createElement("canvas",{style:{position:"absolute",left:0,top:0,width:"100%",height:"100%",zIndex:4}},this.wrapper),this.spectrCc=this.canvas.getContext("2d")}render(){if(this.frequenciesDataUrl)this.loadFrequenciesData(this.frequenciesDataUrl);else{const t=this.wavesurfer?.getDecodedData();t&&(this.frequencies&&this.buffer===t||(this.frequencies=this.getFrequencies(t)),this.drawSpectrogram(this.frequencies))}}drawSpectrogram(t){isNaN(t[0][0])||(t=[t]),this.wrapper.style.height=this.height*t.length+"px",this.canvas.width=this.getWidth(),this.canvas.height=this.height*t.length;const e=this.spectrCc,s=this.height,i=this.getWidth(),r=this.buffer.sampleRate/2,a=this.frequencyMin,n=this.frequencyMax;if(!e)return;if(n>r){const r=this.colorMap[this.colorMap.length-1];e.fillStyle=`rgba(${r[0]}, ${r[1]}, ${r[2]}, ${r[3]})`,e.fillRect(0,0,i,s*t.length)}const h=this._offscreenCanvas,o=h.getContext("2d");for(let l=0;l<t.length;l++){const c=this.resample(t[l]),u=c[0].length,f=new ImageData(i,u),p=f.data;if(!this._colorCache){this._colorCache=new Uint8ClampedArray(4*this.colorMap.length);for(let t=0;t<this.colorMap.length;t++){const e=this.colorMap[t],s=4*t;this._colorCache[s]=Math.round(255*e[0]),this._colorCache[s+1]=Math.round(255*e[1]),this._colorCache[s+2]=Math.round(255*e[2]),this._colorCache[s+3]=Math.round(255*e[3])}}const d=this._colorCache,b=i,g=u;for(let t=0;t<c.length;t++){const e=c[t];for(let s=0;s<g;s++){const i=e[s]<<2,r=(g-s-1)*b+t<<2;p[r]=d[i],p[r+1]=d[i+1],p[r+2]=d[i+2],p[r+3]=d[i+3]}}const w=this.hzToScale(a)/this.hzToScale(r),M=this.hzToScale(n)/this.hzToScale(r),m=Math.min(1,M);h.width=i,h.height=u,o.putImageData(f,0,0);const k=Math.round(u*(1-m)),y=Math.round(u*Math.max(0,m-w)),T=s*(l+1-m/M),v=s*m/M;e.drawImage(h,0,k,i,y,0,T,i,v)}this.options.labels&&this.loadLabels(this.options.labelsBackground,"12px","12px","",this.options.labelsColor,this.options.labelsHzColor||this.options.labelsColor,"center","#specLabels",t.length),this.emit("ready")}createFilterBank(t,e,s,i){const r=s(0),a=s(e/2),n=e/this.fftSamples,h=this.fftSamples>>1,o=a-r,l=1/t,c=[];for(let e=0;e<t;e++){const t=new Float32Array(h+1);let s=i(r+e*l*o),a=Math.floor(s/n),u=a*n,f=(s-u)/((a+1)*n-u);t[a]=1-f,t[a+1]=f,c[e]=t}return c}hzToMel(t){return 2595*Math.log10(1+t/700)}melToHz(t){return 700*(Math.pow(10,t/2595)-1)}createMelFilterBank(t,e){return this.createFilterBank(t,e,this.hzToMel.bind(this),this.melToHz.bind(this))}hzToLog(t){return Math.log10(Math.max(1,t))}logToHz(t){return Math.pow(10,t)}createLogFilterBank(t,e){return this.createFilterBank(t,e,this.hzToLog.bind(this),this.logToHz.bind(this))}hzToBark(t){let e=26.81*t/(1960+t)-.53;return e<2&&(e+=.15*(2-e)),e>20.1&&(e+=.22*(e-20.1)),e}barkToHz(t){return t<2&&(t=(t-.3)/.85),t>20.1&&(t=(t+4.422)/1.22),(t+.53)/(26.28-t)*1960}createBarkFilterBank(t,e){return this.createFilterBank(t,e,this.hzToBark.bind(this),this.barkToHz.bind(this))}hzToErb(t){return ERB_A*Math.log10(1+.00437*t)}erbToHz(t){return(Math.pow(10,t/ERB_A)-1)/.00437}createErbFilterBank(t,e){return this.createFilterBank(t,e,this.hzToErb.bind(this),this.erbToHz.bind(this))}hzToScale(t){switch(this.scale){case"mel":return this.hzToMel(t);case"logarithmic":return this.hzToLog(t);case"bark":return this.hzToBark(t);case"erb":return this.hzToErb(t)}return t}scaleToHz(t){switch(this.scale){case"mel":return this.melToHz(t);case"logarithmic":return this.logToHz(t);case"bark":return this.barkToHz(t);case"erb":return this.erbToHz(t)}return t}applyFilterBank(t,e){const s=e.length,i=t.length,r=new Float32Array(s);for(let a=0;a<s;a++){const s=e[a];let n=0;for(let e=0;e<i;e++)n+=t[e]*s[e];r[a]=n}return r}getWidth(){return this.wavesurfer.getWrapper().offsetWidth}getFrequencies(t){const e=this.fftSamples,s=this.options.splitChannels??this.wavesurfer?.options.splitChannels?t.numberOfChannels:1;if(this.frequencyMax=this.frequencyMax||t.sampleRate/2,!t)return;this.buffer=t;const i=t.sampleRate,r=[];let a=this.noverlap;if(!a){const s=t.length/this.canvas.width;a=Math.max(0,Math.round(e-s))}this._fft&&this._fft.bufferSize===e&&this._fft.sampleRate===i||(this._fft=new FFT(e,i,this.windowFunc,this.alpha));const n=this._fft;let h;switch(this.scale){case"mel":{const t=`mel|${this.numMelFilters}|${i}`;this._filterBankCache.has(t)?h=this._filterBankCache.get(t):(h=this.createFilterBank(this.numMelFilters,i,this.hzToMel.bind(this),this.melToHz.bind(this)),this._filterBankCache.set(t,h))}break;case"logarithmic":{const t=`log|${this.numLogFilters}|${i}`;this._filterBankCache.has(t)?h=this._filterBankCache.get(t):(h=this.createFilterBank(this.numLogFilters,i,this.hzToLog.bind(this),this.logToHz.bind(this)),this._filterBankCache.set(t,h))}break;case"bark":{const t=`bark|${this.numBarkFilters}|${i}`;this._filterBankCache.has(t)?h=this._filterBankCache.get(t):(h=this.createFilterBank(this.numBarkFilters,i,this.hzToBark.bind(this),this.barkToHz.bind(this)),this._filterBankCache.set(t,h))}break;case"erb":{const t=`erb|${this.numErbFilters}|${i}`;this._filterBankCache.has(t)?h=this._filterBankCache.get(t):(h=this.createFilterBank(this.numErbFilters,i,this.hzToErb.bind(this),this.erbToHz.bind(this)),this._filterBankCache.set(t,h))}}const o=e>>1,l=-this.gainDB,c=l-this.rangeDB,u=255/this.rangeDB;for(let i=0;i<s;i++){const s=t.getChannelData(i),f=[];let p=0;for(;p+e<s.length;){const t=s.subarray(p,p+e),i=new Uint8Array(o);let r=n.calculateSpectrum(t);h&&(r=this.applyFilterBank(r,h));for(let t=0;t<o;t++){const e=r[t]>1e-12?r[t]:1e-12,s=20*Math.log10(e);i[t]=s<c?0:s>l?255:(s+this.gainDB)*u+256}f.push(i),p+=e-a}r.push(f)}return this.frequencies=r,r}freqType(t){return t>=1e3?(t/1e3).toFixed(1):Math.round(t)}unitType(t){return t>=1e3?"kHz":"Hz"}getLabelFrequency(t,e){const s=this.hzToScale(this.frequencyMin),i=this.hzToScale(this.frequencyMax);return this.scaleToHz(s+t/e*(i-s))}loadLabels(t,e,s,i,r,a,n,h,o){t=t||"rgba(68,68,68,0)",e=e||"12px",s=s||"12px",i=i||"Helvetica",r=r||"#fff",a=a||"#fff",n=n||"center",h=h||"#specLabels";const l=this.height||512,c=l/256*5,u=this.labelsEl.getContext("2d"),f=window.devicePixelRatio||1;if(this.labelsEl.width=55*f,this.labelsEl.height=this.height*o*f,u.setTransform(1,0,0,1,0,0),u.scale(f,f),!u)return;const p=e+" "+i,d=s+" "+i,b=1/c;for(let e=0;e<o;e++){u.fillStyle=t,u.fillRect(0,e*l,55,(1+e)*l),u.fill(),u.textAlign=n,u.textBaseline="middle";for(let t=0;t<=c;t++){const s=this.getLabelFrequency(t,c),i=this.freqType(s),n=this.unitType(s),h=16;let o=(1+e)*l-t*b*l;o=Math.min(Math.max(o,e*l+10),(1+e)*l-10),u.fillStyle=a,u.font=d,u.fillText(n,h+24,o),u.fillStyle=r,u.font=p,u.fillText(i,h,o)}}}resample(t){const e=this.getWidth(),s=[],i=t.length,r=t[0].length;if(e<=1||i<=1)return t.slice();const a=(i-1)/(e-1);for(let n=0;n<e;n++){const e=n*a,h=Math.floor(e),o=Math.min(i-1,h+1),l=e-h,c=t[h],u=t[o],f=new Uint8Array(r);if(0===l)for(let t=0;t<r;t++)f[t]=c[t];else{const t=1-l;for(let e=0;e<r;e++)f[e]=Math.round(t*c[e]+l*u[e])}s.push(f)}return s}}export default SpectrogramPlugin;