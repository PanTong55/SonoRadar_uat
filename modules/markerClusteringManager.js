export class MarkerClusteringManager{constructor(e,r={}){this.map=e,this.worker=null,this.isWorkerReady=!1,this.maxVisibleMarkers=r.maxVisibleMarkers||500,this.enableAnimation=!1!==r.enableAnimation,this.animationDuration=r.animationDuration||300,this.allSurveyPoints=[],this.currentClusters=[],this.currentVisibleMarkers=[],this.clusterMarkersMap=new Map,this.visibleMarkersMap=new Map,this.clusterLayerGroup=null,this.markerLayerGroup=null,this.computationInFlight=!1,this.pendingComputeRequest=null,this.isClustered=!0,this.wasClusteredBefore=!0,this.zoomThrottleTimer=null,this.zoomThrottleDelay=200,this.pinnedPointIds=new Set,this.errorCount=0,this.maxErrorCount=5,this.init()}init(){try{this.worker=new Worker(new URL("./clusterWorker.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>this.handleWorkerMessage(e),this.worker.onerror=e=>{console.error("[ClusterManager] Worker error:",e),this.onWorkerError()},this.isWorkerReady=!0,console.log("[ClusterManager] Worker initialized")}catch(e){console.warn("[ClusterManager] Worker not supported, degrading to main thread:",e),this.isWorkerReady=!1}this.clusterLayerGroup=L.layerGroup(),this.markerLayerGroup=L.layerGroup(),this.map.on("zoomstart",(()=>this.onZoomOrMoveStart())),this.map.on("zoomend",(()=>this.onZoomOrMoveEnd())),this.map.on("moveend",(()=>this.onZoomOrMoveEnd())),console.log("[ClusterManager] Initialized")}setSurveyPoints(e){if(this.allSurveyPoints=e,console.log(`[ClusterManager] Received ${e.length} survey points`),this.isWorkerReady&&this.worker)try{this.worker.postMessage({type:"INIT",payload:{points:this.serializePoints(e)}})}catch(e){console.error("[ClusterManager] Error sending INIT to Worker:",e),this.onWorkerError()}this.scheduleComputation()}serializePoints(e){return e.map(((e,r)=>{const t=Number(e.lat),s=Number(e.lng);return isFinite(t)&&isFinite(s)||console.warn("[ClusterManager] Invalid point at index",r,":",e),{id:e.id||`survey_${r}`,lat:t,lng:s,meta:{location:e.location||"Survey Point"}}}))}onZoomOrMoveStart(){this.zoomThrottleTimer&&(clearTimeout(this.zoomThrottleTimer),this.zoomThrottleTimer=null)}onZoomOrMoveEnd(){this.scheduleComputation()}scheduleComputation(){this.zoomThrottleTimer&&clearTimeout(this.zoomThrottleTimer),this.zoomThrottleTimer=setTimeout((()=>{this.zoomThrottleTimer=null,this.computeClusters()}),this.zoomThrottleDelay)}computeClusters(){if(!this.map||0===this.allSurveyPoints.length)return;const e=this.map.getZoom(),r=this.map.getBounds(),t={minLat:r.getSouth(),maxLat:r.getNorth(),minLng:r.getWest(),maxLng:r.getEast()};if(this.isWorkerReady&&this.worker&&!this.computationInFlight)try{this.computationInFlight=!0,this.worker.postMessage({type:"COMPUTE_CLUSTERS",payload:{zoom:e,bounds:t}})}catch(e){console.error("[ClusterManager] Error sending COMPUTE_CLUSTERS to Worker:",e),this.computationInFlight=!1,this.onWorkerError()}}onWorkerError(){this.errorCount++,this.errorCount>=this.maxErrorCount&&(console.error("[ClusterManager] Max error count reached, disabling Worker"),this.isWorkerReady=!1,this.worker&&(this.worker.terminate(),this.worker=null))}handleWorkerMessage(e){const{type:r,result:t,message:s,stack:o}=e.data;if("ERROR"===r)return console.error("[ClusterManager] Worker error:",s,o),this.computationInFlight=!1,void this.onWorkerError();"INIT_DONE"!==r?"CLUSTERS_COMPUTED"===r&&(this.errorCount=0,this.computationInFlight=!1,this.currentClusters=t.clusters,this.currentVisibleMarkers=t.visiblePoints,this.isClustered=!1!==t.isClustered,console.log(`[ClusterManager] Computed: ${t.clusters.length} clusters, ${t.visiblePoints.length} visible markers (clustered: ${this.isClustered})`),this.renderClusters()):console.log("[ClusterManager] Worker initialization complete")}renderClusters(){try{const e=this.wasClusteredBefore!==this.isClustered;this.enableAnimation&&this.fadeOutMarkers();const r=this.enableAnimation?150:0;setTimeout((()=>{if(this.clusterLayerGroup.clearLayers(),this.markerLayerGroup.clearLayers(),this.clusterMarkersMap.clear(),this.visibleMarkersMap.clear(),e&&console.log(`[ClusterManager] Mode transition: ${this.wasClusteredBefore?"Clustered":"Unclustered"} â†’ ${this.isClustered?"Clustered":"Unclustered"}`),this.isClustered){for(let e of this.currentClusters)try{const r=this.createClusterMarker(e);this.clusterLayerGroup.addLayer(r),this.clusterMarkersMap.set(e.id,r)}catch(e){console.error("[ClusterManager] Error creating cluster marker:",e)}for(let e of this.currentVisibleMarkers)try{const r=this.createIndividualMarker(e);this.markerLayerGroup.addLayer(r),this.visibleMarkersMap.set(e.id,r),this.pinnedPointIds.has(e.id)&&this.toggleMarkerPin(r,e,!0)}catch(e){console.error("[ClusterManager] Error creating individual marker:",e)}}else for(let e of this.currentVisibleMarkers)try{const r=this.createIndividualMarker(e);this.markerLayerGroup.addLayer(r),this.visibleMarkersMap.set(e.id,r),this.pinnedPointIds.has(e.id)&&this.toggleMarkerPin(r,e,!0)}catch(e){console.error("[ClusterManager] Error creating individual marker:",e)}this.enableAnimation&&this.fadeInMarkers(),this.wasClusteredBefore=this.isClustered,this.updateSurveyPointLayers&&this.updateSurveyPointLayers()}),r)}catch(e){console.error("[ClusterManager] Error during render:",e)}}fadeOutMarkers(){const e=[...this.clusterMarkersMap.values(),...this.visibleMarkersMap.values()];for(let r of e){const e=r.getElement();e&&(e.style.opacity="0.3",e.style.transition="opacity 150ms ease-out")}}fadeInMarkers(){const e=[...this.clusterMarkersMap.values(),...this.visibleMarkersMap.values()];for(let r of e){const e=r.getElement();e&&(e.style.transition=`opacity ${this.animationDuration}ms ease-in`,e.style.opacity="1")}}createClusterMarker(e){const r=L.marker([e.lat,e.lng],{icon:L.divIcon({html:`<div class="cluster-marker-icon" data-cluster-count="${e.count}" title="${e.count} markers" style="pointer-events: auto;">\n          ${e.count}\n        </div>`,className:"cluster-marker-container",iconSize:[40,40],iconAnchor:[20,20],popupAnchor:[0,-20]})});r.bindTooltip(`${e.count} survey sites in this area`,{direction:"top",offset:[0,-20],className:"cluster-tooltip",permanent:!1});return setTimeout((()=>{const e=r.getElement();if(e){const r=e.querySelector(".cluster-marker-icon");r&&(r.addEventListener("mouseenter",(()=>{r.classList.add("cluster-marker-hover")})),r.addEventListener("mouseleave",(()=>{r.classList.remove("cluster-marker-hover")})))}}),0),r}createIndividualMarker(e){const r=L.marker([e.lat,e.lng],{icon:L.divIcon({html:'<i class="fa-solid fa-location-dot" style="color:#000000; text-shadow: 0 0 2px #fff, 0 0 6px #fff;"></i>',className:"map-marker-survey",iconSize:[22,22],iconAnchor:[11,11]})});return r.bindTooltip(e.meta?.location||"Survey Point",{direction:"top",offset:[-6,-22],className:"map-tooltip",permanent:!1}),r.on("click",(t=>{try{t.originalEvent?.stopPropagation()}catch(e){}this.toggleMarkerPin(r,e)})),r._surveyPointData=e,r._tooltipPinned=!1,r._pinnedIsPopup=!1,r}toggleMarkerPin(e,r,t=!1){if(e._tooltipPinned){try{e.closePopup()}catch(e){}try{e.unbindPopup()}catch(e){}e.bindTooltip(r.meta?.location||"Survey Point",{direction:"top",offset:[-6,-22],className:"map-tooltip",permanent:!1}),e._tooltipPinned=!1,e._pinnedIsPopup=!1,this.pinnedPointIds.delete(r.id)}else{try{e.unbindTooltip()}catch(e){}try{e.unbindPopup()}catch(e){}e.bindPopup(r.meta?.location||"Survey Point",{className:"map-tooltip map-tooltip-pinned",closeButton:!1,autoClose:!1,closeOnClick:!1,autoPan:!1,offset:L.point(-6,-8)}),e._tooltipPinned=!0,e._pinnedIsPopup=!0,this.pinnedPointIds.add(r.id),t?setTimeout((()=>{try{e._tooltipPinned&&e.openPopup()}catch(e){}}),50):e.openPopup()}}getBboxForCluster(e){if(!e)return console.warn("[ClusterManager] Cluster is null/undefined"),null;if(!e.points||!Array.isArray(e.points))return console.warn("[ClusterManager] Cluster.points is not an array:",e),null;if(0===e.points.length)return console.warn("[ClusterManager] Cluster has no points"),null;console.log("[ClusterManager] First point in cluster:",e.points[0]);const r=e.points.filter((e=>{if(!e)return!1;const r=Number(e.lat),t=Number(e.lng),s=!isNaN(r)&&!isNaN(t)&&isFinite(r)&&isFinite(t);return s||console.warn("[ClusterManager] Invalid point:",e,"-> lat:",r,"lng:",t),s}));if(0===r.length)return console.warn("[ClusterManager] No valid points in cluster:",e.points),null;const t=r.map((e=>Number(e.lat))),s=r.map((e=>Number(e.lng))),o=Math.min(...t),i=Math.max(...t),n=Math.min(...s),a=Math.max(...s);return isFinite(o)&&isFinite(i)&&isFinite(n)&&isFinite(a)?(console.log("[ClusterManager] Valid bbox for cluster:",{minLat:o,maxLat:i,minLng:n,maxLng:a}),L.latLngBounds([o,n],[i,a])):(console.warn("[ClusterManager] Invalid bounds calculated:",{minLat:o,maxLat:i,minLng:n,maxLng:a}),null)}updateData(e){this.setSurveyPoints(e)}getClusterLayerGroup(){return this.clusterLayerGroup}getMarkerLayerGroup(){return this.markerLayerGroup}getPinnedMarkers(){const e=new Set;for(let r of this.pinnedPointIds){const t=this.visibleMarkersMap.get(r);t&&e.add(t)}return e}destroy(){if(this.zoomThrottleTimer&&clearTimeout(this.zoomThrottleTimer),this.worker)try{this.worker.terminate()}catch(e){console.warn("[ClusterManager] Error terminating worker:",e)}this.clusterLayerGroup&&this.map.removeLayer(this.clusterLayerGroup),this.markerLayerGroup&&this.map.removeLayer(this.markerLayerGroup),this.clusterMarkersMap.clear(),this.visibleMarkersMap.clear(),this.pinnedPointIds.clear(),console.log("[ClusterManager] Destroyed")}}export default MarkerClusteringManager;