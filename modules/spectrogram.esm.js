function t(t,e,s,a){return new(s||(s=Promise))((function(r,i){function n(t){try{o(a.next(t))}catch(t){i(t)}}function h(t){try{o(a.throw(t))}catch(t){i(t)}}function o(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(n,h)}o((a=a.apply(t,e||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class e{constructor(){this.listeners={}}on(t,e,s){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(e),null==s?void 0:s.once){const s=()=>{this.un(t,s),this.un(t,e)};return this.on(t,s),s}return()=>this.un(t,e)}un(t,e){var s;null===(s=this.listeners[t])||void 0===s||s.delete(e)}once(t,e){return this.on(t,e,{once:!0})}unAll(){this.listeners={}}emit(t,...e){this.listeners[t]&&this.listeners[t].forEach((t=>t(...e)))}}class s extends e{constructor(t){super(),this.subscriptions=[],this.options=t}onInit(){}_init(t){this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((t=>t()))}}function r(t,e){const s=e.xmlns?document.createElementNS(e.xmlns,t):document.createElement(t);for(const[t,a]of Object.entries(e))if("children"===t)for(const[t,a]of Object.entries(e))"string"==typeof a?s.appendChild(document.createTextNode(a)):s.appendChild(r(t,a));else"style"===t?Object.assign(s.style,a):"textContent"===t?s.textContent=a:s.setAttribute(t,a.toString());return s}function i(t,e,s){const a=r(t,e||{});return null==s||s.appendChild(a),a}function a(t,e,s,a){switch(this.bufferSize=t,this.sampleRate=e,this.bandwidth=2/t*(e/2),this.sinTable=new Float32Array(t),this.cosTable=new Float32Array(t),this.windowValues=new Float32Array(t),this.reverseTable=new Uint32Array(t),this.peakBand=0,this.peak=0,s){case"bartlett":for(r=0;r<t;r++)this.windowValues[r]=2/(t-1)*((t-1)/2-Math.abs(r-(t-1)/2));break;case"bartlettHann":for(r=0;r<t;r++)this.windowValues[r]=.62-.48*Math.abs(r/(t-1)-.5)-.38*Math.cos(2*Math.PI*r/(t-1));break;case"blackman":for(a=a||.16,r=0;r<t;r++)this.windowValues[r]=(1-a)/2-.5*Math.cos(2*Math.PI*r/(t-1))+a/2*Math.cos(4*Math.PI*r/(t-1));break;case"cosine":for(r=0;r<t;r++)this.windowValues[r]=Math.cos(Math.PI*r/(t-1)-Math.PI/2);break;case"gauss":for(a=a||.25,r=0;r<t;r++)this.windowValues[r]=Math.pow(Math.E,-.5*Math.pow((r-(t-1)/2)/(a*(t-1)/2),2));break;case"hamming":for(r=0;r<t;r++)this.windowValues[r]=.54-.46*Math.cos(2*Math.PI*r/(t-1));break;case"hann":case void 0:for(r=0;r<t;r++)this.windowValues[r]=.5*(1-Math.cos(2*Math.PI*r/(t-1)));break;case"lanczoz":for(r=0;r<t;r++)this.windowValues[r]=Math.sin(Math.PI*(2*r/(t-1)-1))/(Math.PI*(2*r/(t-1)-1));break;case"rectangular":for(r=0;r<t;r++)this.windowValues[r]=1;break;case"triangular":for(r=0;r<t;r++)this.windowValues[r]=2/t*(t/2-Math.abs(r-(t-1)/2));break;default:throw Error("No such window function '"+s+"'")}for(var r,i=1,n=t>>1;i<t;){for(r=0;r<i;r++)this.reverseTable[r+i]=this.reverseTable[r]+n;i<<=1,n>>=1}for(r=0;r<t;r++)this.sinTable[r]=Math.sin(-Math.PI/r),this.cosTable[r]=Math.cos(-Math.PI/r);this._o=new Float32Array(t),this._l=new Float32Array(t),this._f=new Float32Array(t>>1),this.calculateSpectrum=function(t){var e,s,a,r=this.bufferSize,i=this.cosTable,n=this.sinTable,h=this.reverseTable,o=this._o,l=this._l,c=2/this.bufferSize,u=Math.sqrt,f=this._f,p=Math.floor(Math.log(r)/Math.LN2);if(Math.pow(2,p)!==r)throw"Invalid buffer size, must be a power of 2.";if(r!==t.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+r+" Buffer Size: "+t.length;for(var d,M,g,w,b,m,y,k,T=1,v=0;v<r;v++)o[v]=t[h[v]]*this.windowValues[h[v]],l[v]=0;for(;T<r;){d=i[T],M=n[T],g=1,w=0;for(var z=0;z<T;z++){for(v=z;v<r;)m=g*o[b=v+T]-w*l[b],y=g*l[b]+w*o[b],o[b]=o[v]-m,l[b]=l[v]-y,o[v]+=m,l[v]+=y,v+=T<<1;g=(k=g)*d-w*M,w=k*M+w*d}T<<=1}v=0;for(var B=r/2;v<B;v++)(a=c*u((e=o[v])*e+(s=l[v])*s))>this.peak&&(this.peakBand=v,this.peak=a),f[v]=a;return f}}const n=1e3*Math.log(10)/107.939;class h extends s{static create(t){return new h(t||{})}constructor(t){var e,s;if(super(t),this.frequenciesDataUrl=t.frequenciesDataUrl,this.container="string"==typeof t.container?document.querySelector(t.container):t.container,t.colorMap&&"string"!=typeof t.colorMap){if(t.colorMap.length<256)throw new Error("Colormap must contain 256 elements");for(let e=0;e<t.colorMap.length;e++)if(4!==t.colorMap[e].length)throw new Error("ColorMap entries must contain 4 values");this.colorMap=t.colorMap}else switch(this.colorMap=t.colorMap||"roseus",this.colorMap){case"gray":this.colorMap=[];for(let t=0;t<256;t++){const e=(255-t)/256;this.colorMap.push([e,e,e,1])}break;case"igray":this.colorMap=[];for(let t=0;t<256;t++){const e=t/256;this.colorMap.push([e,e,e,1])}break;default:throw Error("No such colormap '"+this.colorMap+"'")}if(this.fftSamples=t.fftSamples||512,this.height=t.height||200,this.noverlap=t.noverlap||null,this.windowFunc=t.windowFunc||"hann",this.alpha=t.alpha,this.frequencyMin=t.frequencyMin||0,this.frequencyMax=t.frequencyMax||0,this.gainDB=null!==(e=t.gainDB)&&void 0!==e?e:20,this.rangeDB=null!==(s=t.rangeDB)&&void 0!==s?s:80,this.scale=t.scale||"mel",this.numMelFilters=this.fftSamples/2,this.numLogFilters=this.fftSamples/2,this.numBarkFilters=this.fftSamples/2,this.numErbFilters=this.fftSamples/2,this.createWrapper(),this.createCanvas(),this._filterBankCache={},this._resampleCache={},this._colorMapUint=new Uint8ClampedArray(1024),this.colorMap&&this._colorMapUint)for(let t=0;t<256;t++){const e=this.colorMap[t]||[0,0,0,1];this._colorMapUint[4*t]=Math.round(255*e[0]),this._colorMapUint[4*t+1]=Math.round(255*e[1]),this._colorMapUint[4*t+2]=Math.round(255*e[2]),this._colorMapUint[4*t+3]=Math.round(255*e[3])}}onInit(){this.container=this.container||this.wavesurfer.getWrapper(),this.container.appendChild(this.wrapper),this.wavesurfer.options.fillParent&&Object.assign(this.wrapper.style,{width:"100%",overflowX:"hidden",overflowY:"hidden"}),this.subscriptions.push(this.wavesurfer.on("redraw",(()=>this.render())))}destroy(){this.unAll(),this.wavesurfer.un("ready",this._onReady),this.wavesurfer.un("redraw",this._onRender),this.wavesurfer=null,this.util=null,this.options=null,this.wrapper&&(this.wrapper.remove(),this.wrapper=null),super.destroy()}loadFrequenciesData(e){return t(this,void 0,void 0,(function*(){const t=yield fetch(e);if(!t.ok)throw new Error("Unable to fetch frequencies data");const s=yield t.json();this.drawSpectrogram(s)}))}createWrapper(){this.wrapper=i("div",{style:{display:"block",position:"relative",userSelect:"none"}}),this.options.labels&&(this.labelsEl=i("canvas",{part:"spec-labels",style:{position:"absolute",zIndex:9,width:"55px",height:"100%"}},this.wrapper)),this.wrapper.addEventListener("click",this._onWrapperClick)}createCanvas(){this.canvas=i("canvas",{style:{position:"absolute",left:0,top:0,width:"100%",height:"100%",zIndex:4}},this.wrapper),this.spectrCc=this.canvas.getContext("2d")}render(){var t;if(this.frequenciesDataUrl)this.loadFrequenciesData(this.frequenciesDataUrl);else{const e=null===(t=this.wavesurfer)||void 0===t?void 0:t.getDecodedData();e&&this.drawSpectrogram(this.getFrequencies(e))}}drawSpectrogram(t){isNaN(t[0][0])||(t=[t]),this.wrapper.style.height=this.height*t.length+"px",this.canvas.width=this.getWidth(),this.canvas.height=this.height*t.length;const e=this.spectrCc,s=this.height,a=this.getWidth(),r=this.buffer.sampleRate/2,i=this.frequencyMin,n=this.frequencyMax;if(e){if(n>r){const r=this.colorMap[this.colorMap.length-1];e.fillStyle=`rgba(${r[0]}, ${r[1]}, ${r[2]}, ${r[3]})`,e.fillRect(0,0,a,s*t.length)}for(let h=0;h<t.length;h++){const o=this.resample(t[h]),l=o[0].length,c=new ImageData(a,l),u=this.peakBandArrayPerChannel&&this.peakBandArrayPerChannel[h]?this.peakBandArrayPerChannel[h]:[],f=`${t[h].length}:${a}`,p=this._resampleCache[f];for(let t=0;t<o.length;t++)for(let e=0;e<o[t].length;e++){let s=o[t][e];s<0?s=0:s>255&&(s=255);const r=4*s,i=4*((l-e-1)*a+t);let n=!1,h=!1;if(this.options.peakMode&&p&&p[t])for(let s=0;s<p[t].length;s++){const a=u[p[t][s][0]];if(a&&a.bin===e){n=!0,h=a.isHigh;break}}n?h?(c.data[i]=255,c.data[i+1]=112,c.data[i+2]=252,c.data[i+3]=255):(c.data[i]=255,c.data[i+1]=0,c.data[i+2]=0,c.data[i+3]=255):(c.data[i]=this._colorMapUint[r],c.data[i+1]=this._colorMapUint[r+1],c.data[i+2]=this._colorMapUint[r+2],c.data[i+3]=this._colorMapUint[r+3])}const d=this.hzToScale(i)/this.hzToScale(r),M=this.hzToScale(n)/this.hzToScale(r),g=Math.min(1,M);createImageBitmap(c,0,Math.round(l*(1-g)),a,Math.round(l*(g-d))).then((t=>{e.drawImage(t,0,s*(h+1-g/M),a,s*g/M)}))}this.options.labels&&this.loadLabels(this.options.labelsBackground,"12px","12px","",this.options.labelsColor,this.options.labelsHzColor||this.options.labelsColor,"center","#specLabels",t.length),this.emit("ready")}}createFilterBank(t,e,s,a){const r=this.frequencyMin||"0",i=this.frequencyMax||"0",n=`${this.scale}:${t}:${e}:${this.fftSamples}:${r}:${i}`;if(this._filterBankCache[n])return this._filterBankCache[n];const h=s(0),o=s(e/2),l=this.frequencyMin>0?s(this.frequencyMin):h,c=this.frequencyMax>0&&this.frequencyMax<e/2?s(this.frequencyMax):o,u=Array.from({length:t},(()=>{const t=this.fftSamples/2+1,e=new Float32Array(t);return e.fill(0),e})),f=e/this.fftSamples;for(let e=0;e<t;e++){let s=a(l+e/t*(c-l)),r=Math.floor(s/f),i=r*f,n=(s-i)/((r+1)*f-i);r>=0&&r<u[e].length&&(u[e][r]=1-n),r+1>=0&&r+1<u[e].length&&(u[e][r+1]=n)}return this._filterBankCache[n]=u,u}hzToMel(t){return 2595*Math.log10(1+t/700)}melToHz(t){return 700*(Math.pow(10,t/2595)-1)}createMelFilterBank(t,e){return this.createFilterBank(t,e,this.hzToMel,this.melToHz)}hzToLog(t){return Math.log10(Math.max(1,t))}logToHz(t){return Math.pow(10,t)}createLogFilterBank(t,e){return this.createFilterBank(t,e,this.hzToLog,this.logToHz)}hzToBark(t){let e=26.81*t/(1960+t)-.53;return e<2&&(e+=.15*(2-e)),e>20.1&&(e+=.22*(e-20.1)),e}barkToHz(t){return t<2&&(t=(t-.3)/.85),t>20.1&&(t=(t+4.422)/1.22),(t+.53)/(26.28-t)*1960}createBarkFilterBank(t,e){return this.createFilterBank(t,e,this.hzToBark,this.barkToHz)}hzToErb(t){return n*Math.log10(1+.00437*t)}erbToHz(t){return(Math.pow(10,t/n)-1)/.00437}createErbFilterBank(t,e){return this.createFilterBank(t,e,this.hzToErb,this.erbToHz)}hzToScale(t){switch(this.scale){case"mel":return this.hzToMel(t);case"logarithmic":return this.hzToLog(t);case"bark":return this.hzToBark(t);case"erb":return this.hzToErb(t)}return t}scaleToHz(t){switch(this.scale){case"mel":return this.melToHz(t);case"logarithmic":return this.logToHz(t);case"bark":return this.barkToHz(t);case"erb":return this.erbToHz(t)}return t}applyFilterBank(t,e){const s=e.length,a=Float32Array.from({length:s},(()=>0));for(let r=0;r<s;r++)for(let s=0;s<t.length;s++)a[r]+=t[s]*e[r][s];return a}getWidth(){return this.wavesurfer.getWrapper().offsetWidth}getFrequencies(t){var e,s;const r=this.fftSamples,i=(null!==(e=this.options.splitChannels)&&void 0!==e?e:null===(s=this.wavesurfer)||void 0===s?void 0:s.options.splitChannels)?t.numberOfChannels:1;if(this.frequencyMax=this.frequencyMax||t.sampleRate/2,!t)return;this.buffer=t;const n=t.sampleRate,h=[];let o=this.noverlap;if(!o){const e=t.length/this.canvas.width;o=Math.max(0,Math.round(r-e))}const l=Math.floor(this.frequencyMin*r/n),c=Math.ceil(this.frequencyMax*r/n),u=new a(r,n,this.windowFunc,this.alpha);let f;switch(this.scale){case"mel":f=this.createFilterBank(this.numMelFilters,n,this.hzToMel,this.melToHz);break;case"logarithmic":f=this.createFilterBank(this.numLogFilters,n,this.hzToLog,this.logToHz);break;case"bark":f=this.createFilterBank(this.numBarkFilters,n,this.hzToBark,this.barkToHz);break;case"erb":f=this.createFilterBank(this.numErbFilters,n,this.hzToErb,this.erbToHz)}this.peakBandArrayPerChannel=[];const p=-this.gainDB,d=p-this.rangeDB,M=255/this.rangeDB;if(this.options.peakMode){let e=0;for(let s=0;s<i;s++){const a=t.getChannelData(s);let i=0;for(;i+r<a.length;){const t=a.subarray(i,i+r);u.peak=0;let s=u.calculateSpectrum(t),n=0;for(let t=l;t<c&&t<s.length;t++)n=Math.max(n,s[t]||0);e=Math.max(e,n),i+=r-o}}const s=e*(void 0!==this.options.peakThreshold?this.options.peakThreshold:.4),a=.7*e;for(let e=0;e<i;e++){const i=t.getChannelData(e),n=[],g=[];let w=0;for(;w+r<i.length;){const t=i.subarray(w,w+r),e=new Uint8Array(r/2);u.peak=0;let h=u.calculateSpectrum(t),b=Math.max(0,l),m=h[b]||0;for(let t=l;t<c&&t<h.length;t++)(h[t]||0)>m&&(m=h[t],b=t);m>=s?g.push({bin:b,isHigh:m>=a}):g.push(null);let y=h;f&&(y=this.applyFilterBank(y,f));const k=f?0:l,T=f?r/2:Math.min(c,r/2);for(let t=k;t<T;t++){const s=y[t]>1e-12?y[t]:1e-12,a=20*Math.log10(s);e[t]=a<d?0:a>p?255:(a+this.gainDB)*M+256}n.push(e),w+=r-o}this.peakBandArrayPerChannel.push(g),h.push(n)}}else for(let e=0;e<i;e++){const s=t.getChannelData(e),a=[];let i=0;for(;i+r<s.length;){const t=new Uint8Array(r/2);u.peak=0;let e=u.calculateSpectrum(s.subarray(i,i+r));f&&(e=this.applyFilterBank(e,f));const n=f?0:l,h=f?r/2:Math.min(c,r/2);for(let s=n;s<h;s++){const a=e[s]>1e-12?e[s]:1e-12,r=20*Math.log10(a);t[s]=r<d?0:r>p?255:(r+this.gainDB)*M+256}a.push(t),i+=r-o}h.push(a)}return h}freqType(t){return t>=1e3?(t/1e3).toFixed(1):Math.round(t)}unitType(t){return t>=1e3?"kHz":"Hz"}getLabelFrequency(t,e){const s=this.hzToScale(this.frequencyMin),a=this.hzToScale(this.frequencyMax);return this.scaleToHz(s+t/e*(a-s))}loadLabels(t,e,s,a,r,i,n,h,o){t=t||"rgba(68,68,68,0)",e=e||"12px",s=s||"12px",a=a||"Helvetica",r=r||"#fff",i=i||"#fff",n=n||"center";const l=this.height||512,c=l/256*5;this.frequencyMin,this.frequencyMax;const u=this.labelsEl.getContext("2d"),f=window.devicePixelRatio;if(this.labelsEl.height=this.height*o*f,this.labelsEl.width=55*f,u.scale(f,f),u)for(let h=0;h<o;h++){let o;for(u.fillStyle=t,u.fillRect(0,h*l,55,(1+h)*l),u.fill(),o=0;o<=c;o++){u.textAlign=n,u.textBaseline="middle";const t=this.getLabelFrequency(o,c),f=this.freqType(t),p=this.unitType(t),d=16;let M=(1+h)*l-o/c*l;M=Math.min(Math.max(M,h*l+10),(1+h)*l-10),u.fillStyle=i,u.font=s+" "+a,u.fillText(p,d+24,M),u.fillStyle=r,u.font=e+" "+a,u.fillText(f,d,M)}}}resample(t){const e=this.getWidth(),s=[],a=1/t.length,r=`${t.length}:${e}`;let i=this._resampleCache[r];if(!i){i=new Array(e);const s=1/e;for(let r=0;r<e;r++){const e=[];for(let i=0;i<t.length;i++){const t=i*a,n=t+a,h=r*s,o=h+s,l=Math.max(0,Math.min(n,o)-Math.max(t,h));l>0&&e.push([i,l/s])}i[r]=e}this._resampleCache[r]=i}for(let a=0;a<e;a++){const e=new Array(t[0].length),r=i[a];for(let s=0;s<r.length;s++){const a=r[s][0],i=r[s][1],n=t[a];for(let t=0;t<n.length;t++)null==e[t]&&(e[t]=0),e[t]+=i*n[t]}const n=new Uint8Array(t[0].length);for(let s=0;s<t[0].length;s++)n[s]=e[s];s.push(n)}return s}}export{h as default};