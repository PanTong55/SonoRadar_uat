import{getCurrentIndex,getFileMetadata,getFileList,getFileIconState}from"./fileState.js";import{showMessageBox}from"./messageBox.js";import{Dropdown}from"./dropdown.js";import MarkerClusteringManager from"./markerClusteringManager.js";let importKmlFileFn=null,clusterManager=null,surveyPointsDataPending=!1,surveyPointsLoaded=!1;export function initMapPopup({buttonId:t="mapBtn",popupId:e="mapPopup",mapId:o="map"}={}){const n=document.getElementById(t),a=document.getElementById(e),i=document.getElementById(o),r=document.getElementById("viewer-container"),l=document.getElementById("control-bar"),s=document.getElementById("sidebar"),c=a.querySelector(".popup-drag-bar"),p=a.querySelector(".popup-close-btn"),d=a.querySelector(".popup-min-btn"),m=a.querySelector(".popup-max-btn");if(!n||!a||!i)return;i.style.cursor="default";function u(t,e){const o=a.getBoundingClientRect(),n=t-o.left,i=e-o.top,r=i>=-5&&i<=o.height+5,l=n>=-5&&n<=o.width+5;return{onLeft:Math.abs(n-0)<=5&&r,onRight:Math.abs(n-o.width)<=5&&r,onTop:Math.abs(i-0)<=5&&l,onBottom:Math.abs(i-o.height)<=5&&l}}function g(t){const{onLeft:e,onRight:o,onTop:n,onBottom:a}=t;let i="";return e&&n||o&&a?i="nwse-resize":o&&n||e&&a?i="nesw-resize":e||o?i="ew-resize":(n||a)&&(i="ns-resize"),i}let y=parseInt(localStorage.getItem("mapPopupWidth"),10),f=parseInt(localStorage.getItem("mapPopupHeight"),10);(isNaN(y)||y<=0)&&(y=600),(isNaN(f)||f<=0)&&(f=600),a.style.width=`${y}px`,a.style.height=`${f}px`;let h=null,v=[],E=new Set,x=[],w=null,P=null,b=null,D=[],k=null,M=null,T=null,C=null,S=null,I=null,F=null,z=!1,$=[],H=null,N=!1,B=null,O=null,_=!1,R=null,A=null,U=[],W=!1,G=!1;const q="8e81149cfda80214b01f32e8e96ede43ee9c42b797e7af1c5c979429622ce40c";function K(){if(!W){U.forEach((({layer:t,name:e})=>{try{R.addOverlay(t,e)}catch(t){}})),U=[],W=!0;try{I?.parentElement&&(I.parentElement.style.display="none")}catch(t){}surveyPointsLoaded||surveyPointsDataPending||function(){if(surveyPointsDataPending||surveyPointsLoaded)return;surveyPointsDataPending=!0,fetch("https://opensheet.elk.sh/1Al_sWwiIU6DtQv6sMFvXb9wBUbBiE-zcYk8vEwV82x8/sheet3").then((t=>t.json())).then((t=>{clusterManager||(clusterManager=new MarkerClusteringManager(h,{maxVisibleMarkers:500,enableAnimation:!0,animationDuration:300}));const e=t.filter((t=>{const e=parseFloat(t.Latitude),o=parseFloat(t.Longitude);return!isNaN(e)&&!isNaN(o)})).map(((t,e)=>({id:`survey_${e}`,lat:parseFloat(t.Latitude),lng:parseFloat(t.Longitude),location:t.Location})));clusterManager.setSurveyPoints(e);try{const t=L.layerGroup();R&&R.addOverlay(t,"Survey point");const e=()=>{if(!h.hasLayer(t))return;const e=clusterManager.getClusterLayerGroup(),o=clusterManager.getMarkerLayerGroup(),n=[];t.eachLayer((t=>{t._tooltipPinned&&t._pinnedIsPopup&&n.push({id:t._surveyPointData?.id,shouldReopen:!0})})),t.clearLayers();const a=clusterManager.isClustered;console.log(`[MapPopup] updateSurveyPointLayers: isClustered=${a}, clusters=${clusterManager.currentClusters?.length||0}, visibleMarkers=${clusterManager.currentVisibleMarkers?.length||0}`),a&&e?e.eachLayer((e=>{t.addLayer(e)})):!a&&o&&o.eachLayer((e=>{t.addLayer(e)})),clusterManager.getPinnedMarkers&&(E=clusterManager.getPinnedMarkers(),setTimeout((()=>{E.forEach((t=>{try{t?._tooltipPinned&&t._pinnedIsPopup&&t.openPopup()}catch(t){}}))}),20))};h.on("zoomend",e),h.on("moveend",e),h.on("overlayadd",(t=>{"Survey point"===t.name&&e()})),clusterManager.surveyPointLayer=t,clusterManager.updateSurveyPointLayers=e}catch(t){console.error("[MapPopup] Error adding survey point overlay:",t)}surveyPointsLoaded=!0,surveyPointsDataPending=!1,console.log("[MapPopup] Survey points loaded successfully")})).catch((t=>{console.error("[MapPopup] Error loading survey points:",t),surveyPointsDataPending=!1}))}()}}async function X(){try{G=!0;const t=()=>{showMessageBox({title:"Professional option",message:"To access more layers, please enter password.",confirmText:"Confirm",cancelText:"Cancel",input:!0,inputType:"password",onConfirm:async e=>{const o=await async function(t){try{const e=(new TextEncoder).encode(t),o=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(o)).map((t=>t.toString(16).padStart(2,"0"))).join("")}catch(t){return null}}(e||"");if(o&&o===q){K();try{if(I){const t=I.parentElement;t&&(t.style.display="none")}}catch(t){}}else showMessageBox({message:"Wrong password",confirmText:"OK",onConfirm:()=>{t()}})},onCancel:()=>{}})};t()}catch(t){}}const Y=i.querySelector(".coord-scale-wrapper"),Z=i.querySelector("#coord-display"),j=i.querySelector("#no-coord-message"),V=i.querySelector("#copy-coord-message");let J=null,Q=null,tt=!1,et=!1,ot=null,nt=null,at=null,it=null,rt=null;const lt=document.createElement("input");lt.type="file",lt.accept=".kml",lt.style.display="none",a.appendChild(lt);const st=document.getElementById("map-drop-overlay");let ct=0,pt=!1,dt=!1;function mt(){if(dt)return;[...v,...$].forEach((t=>{const e=t.getElement?t.getElement():t._icon;e&&(e.style.pointerEvents=pt?"none":"")}))}function ut(){i.style.cursor=tt?"grabbing":z?"text":"default"}function gt(){st&&(st.style.display="none",st.style.pointerEvents="none"),h?.dragging.enable()}function yt(){j&&(j.style.display="none")}function ft(t,e){function o(t){try{dt=!t;[...v,...$].forEach((e=>{const o=e.getElement?e.getElement():e._icon;o&&(o.style.pointerEvents=t?"":"none")})),"undefined"!=typeof surveyPointLayer&&surveyPointLayer&&surveyPointLayer.eachLayer&&surveyPointLayer.eachLayer((e=>{const o=e.getElement?e.getElement():e._icon;o&&(o.style.pointerEvents=t?"":"none")}))}catch(t){}}if(h=L.map(i).setView([t,e],13),h.on("click",(()=>{try{if(tt)return;E.forEach((t=>{try{t?._tooltipPinned&&(t._pinnedIsPopup?t.openPopup():t.openTooltip())}catch(t){}}))}catch(t){}})),document.addEventListener("click",(()=>{try{if(tt)return;E.forEach((t=>{try{t?._tooltipPinned&&(t._pinnedIsPopup?t.openPopup():t.openTooltip())}catch(t){}}))}catch(t){}})),h&&h.on&&(h.on("tooltipclose",(t=>{try{if(tt)return;const e=t.layer||t.tooltip&&t.tooltip._source||null;e&&E.has(e)&&e._tooltipPinned&&!e._pinnedIsPopup&&setTimeout((()=>{try{e._tooltipPinned&&e.openTooltip()}catch(t){}}),0)}catch(t){}})),h.on("popupclose",(t=>{try{if(tt||et)return;const e=t.layer||t.popup&&t.popup._source||t.popup&&t.popup._source||null;e&&E.has(e)&&e._tooltipPinned&&e._pinnedIsPopup&&setTimeout((()=>{try{e._tooltipPinned&&e.openPopup()}catch(t){}}),0)}catch(t){}}))),h.createPane("annotationPane"),h.getPane("annotationPane").style.zIndex=650,nt=h.zoomControl.getContainer(),h.on("dragstart",(()=>{tt=!0,o(!1),ut()})),h.on("dragend",(()=>{tt=!1,o(!0),ut()})),h.on("zoomstart",(()=>{et=!0,o(!1)})),h.on("zoomend",(()=>{et=!1,o(!0)})),ut(),Q=L.control.scale({position:"bottomleft",metric:!0,imperial:!1}).addTo(h),Y){const t=Q.getContainer();t.style.position="static",Y.appendChild(t)}function n(t){if(!Z)return;const{lat:e,lng:o}=t;Z.textContent=`${e.toFixed(4)} ${o.toFixed(4)}`}h.on("mousemove",(t=>n(t.latlng))),h.on("move",(()=>n(h.getCenter()))),n(h.getCenter()),h.on("contextmenu",(t=>{const{lat:e,lng:o}=t.latlng,n=`${e.toFixed(6)}\t${o.toFixed(6)}`;navigator.clipboard?.writeText(n).catch((()=>{})),V&&(V.style.display="flex",clearTimeout(J),J=setTimeout((()=>{V.style.display="none"}),3e3))}));const a={attribution:"&copy; CARTO"},r={attribution:"&copy; Google"},l=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors",crossOrigin:"anonymous"}).addTo(h),s=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; Esri",crossOrigin:"anonymous"}),c=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{...a,crossOrigin:"anonymous"}),p=L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{...a,crossOrigin:"anonymous"}),d=L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{...r,crossOrigin:"anonymous"}),m=L.tileLayer("https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{...r,crossOrigin:"anonymous"}),u=L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",{...r,crossOrigin:"anonymous"}),g=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/imagery/wgs84/{z}/{x}/{y}.png",{attribution:"&copy; HKSAR Government",minZoom:0,maxZoom:19,crossOrigin:"anonymous"}),y=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/basemap/wgs84/{z}/{x}/{y}.png",{attribution:"&copy; HKSAR Government",maxZoom:20,minZoom:10,crossOrigin:"anonymous"}),f=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/label/hk/en/wgs84/{z}/{x}/{y}.png",{attribution:!1,maxZoom:20,minZoom:0,crossOrigin:"anonymous"}),x=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/label/hk/en/wgs84/{z}/{x}/{y}.png",{attribution:!1,maxZoom:20,minZoom:0,crossOrigin:"anonymous"}),D=L.tileLayer("https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}",{attribution:"Map data ©2025 Google",crossOrigin:"anonymous"}),z=L.layerGroup([y,f]),H=L.layerGroup([g,x]);h.on("zoomend",(()=>{h.getZoom()>19&&h.hasLayer(H)&&h.setZoom(19)}));const N={OpenStreetMap:l,"Esri Satellite":s,"Carto Light":c,"Carto Dark":p,"Google Streets":d,"Google Satellite":m,"Google Hybrid":u,"Google Terrain":D,"HK Vector":z,"HK Imagery":H};R=L.control.layers(N,null,{position:"topright"}).addTo(h),ot=R.getContainer(),fetch("https://raw.githubusercontent.com/hkbatradar/SonoRadar/main/hkgrid.geojson").then((t=>t.json())).then((t=>{A=L.geoJSON(t,{interactive:!1,style:{color:"#3388ff",weight:2,fillColor:"#3388ff",fillOpacity:0}}),U.push({layer:A,name:"1km Grid"})})),O=(new L.FeatureGroup).addTo(h);L.canvas({pane:"annotationPane"});B=new L.Control.Draw({position:"topleft",edit:{featureGroup:O},draw:{circlemarker:!1,polyline:{},polygon:{},rectangle:{},circle:{}}}),h.on(L.Draw.Event.CREATED,(t=>{O.addLayer(t.layer)}));const _=new(L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-route-toggle-control");t.style.display="flex";const e=L.DomUtil.create("a","",t);e.href="#",e.title="Route options",e.innerHTML='<i class="fa-solid fa-route"></i>',P=e,L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousedown",L.DomEvent.stopPropagation),L.DomEvent.on(t,"dblclick",L.DomEvent.stopPropagation),b=L.DomUtil.create("div","route-button-group",t),b.style.display="none";const o=L.DomUtil.create("a","",b);o.href="#",o.title="Create Route",o.innerHTML='<i class="fa-solid fa-eye"></i>',w=o,L.DomEvent.on(o,"click",L.DomEvent.stop).on(o,"mousedown",L.DomEvent.stopPropagation).on(o,"dblclick",L.DomEvent.stopPropagation).on(o,"click",xt);const n=L.DomUtil.create("a","",b);n.href="#",n.title="Import KML",n.innerHTML='<i class="fa-solid fa-file-import"></i>',k=n,L.DomEvent.on(n,"click",L.DomEvent.stop).on(n,"mousedown",L.DomEvent.stopPropagation).on(n,"dblclick",L.DomEvent.stopPropagation).on(n,"click",(()=>{lt.value="",lt.click()}));const a=L.DomUtil.create("a","",b);return a.href="#",a.title="Clear KML",a.innerHTML='<i class="fa-solid fa-trash"></i>',M=a,L.DomEvent.on(a,"click",L.DomEvent.stop).on(a,"mousedown",L.DomEvent.stopPropagation).on(a,"dblclick",L.DomEvent.stopPropagation).on(a,"click",Lt),L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"mousedown",L.DomEvent.stopPropagation).on(e,"dblclick",L.DomEvent.stopPropagation).on(e,"click",(()=>{const t="flex"===b.style.display;b.style.display=t?"none":"flex",e.classList.toggle("active",!t)})),t}}));h.addControl(_),at=_.getContainer();const G=new(L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-text-toggle-control"),e=L.DomUtil.create("a","",t);e.href="#",e.title="Text",e.innerHTML='<i class="fa-solid fa-font"></i>',S=e,L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousedown",L.DomEvent.stopPropagation),L.DomEvent.on(t,"dblclick",L.DomEvent.stopPropagation),L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"mousedown",L.DomEvent.stopPropagation).on(e,"dblclick",L.DomEvent.stopPropagation).on(e,"click",Mt);const o=L.DomUtil.create("a","",t);return o.href="#",o.title="Clear Text",o.innerHTML='<i class="fa-solid fa-broom"></i>',T=o,L.DomEvent.on(o,"click",L.DomEvent.stop).on(o,"mousedown",L.DomEvent.stopPropagation).on(o,"dblclick",L.DomEvent.stopPropagation).on(o,"click",(t=>{try{t.preventDefault()}catch(t){}showMessageBox({message:"Confirm to clear all text?",confirmText:"Confirm",cancelText:"Cancel",onConfirm:()=>{try{$.forEach((t=>{try{h&&t&&h.removeLayer(t)}catch(t){}})),$=[],mt()}catch(t){}}})})),t}}));h.addControl(G),rt=G.getContainer();const q=new(L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-export-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Export Map",e.innerHTML='<i class="fa-solid fa-file-export"></i>',F=e,L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousedown",L.DomEvent.stopPropagation),L.DomEvent.on(t,"dblclick",L.DomEvent.stopPropagation),L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"mousedown",L.DomEvent.stopPropagation).on(e,"dblclick",L.DomEvent.stopPropagation).on(e,"click",Pt),t}}));h.addControl(q),it=q.getContainer();const K=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-draw-toggle-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Draw",e.innerHTML='<i class="fa-solid fa-pen-to-square"></i>',C=e,L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousedown",L.DomEvent.stopPropagation),L.DomEvent.on(t,"dblclick",L.DomEvent.stopPropagation),L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"mousedown",L.DomEvent.stopPropagation).on(e,"dblclick",L.DomEvent.stopPropagation).on(e,"click",wt),t}}),j=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-professional-control");t.style.setProperty("margin-top","1px","important");const e=L.DomUtil.create("a","",t);return e.href="#",e.title="Professional",e.innerHTML='<i class="fa-solid fa-user-lock"></i>',I=e,L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousedown",L.DomEvent.stopPropagation),L.DomEvent.on(t,"dblclick",L.DomEvent.stopPropagation),L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"mousedown",L.DomEvent.stopPropagation).on(e,"dblclick",L.DomEvent.stopPropagation).on(e,"click",(()=>{try{X()}catch(t){}})),W&&(t.style.display="none"),t}}),st=new K;h.addControl(st);const ct=new j;h.addControl(ct)}function ht(){if(!h)return;v.forEach((t=>t.remove())),v=[];const t=getFileList(),e=getCurrentIndex(),o={};function n(t){if(!t)return"";return`${(t.date||"").replace(/\D/g,"")}${t.time||""}`}t.forEach(((t,e)=>{const n=getFileMetadata(e),a=parseFloat(n.latitude),i=parseFloat(n.longitude);if(isNaN(a)||isNaN(i))return;const r=`${a.toFixed(6)},${i.toFixed(6)}`;o[r]||(o[r]=[]),o[r].push({file:t,idx:e,meta:n,lat:a,lon:i})})),Object.values(o).forEach((t=>{t.sort(((t,e)=>n(t.meta).localeCompare(n(e.meta))));const o=t[0],{lat:a,lon:i}=o,r=t.some((t=>t.idx===e)),l=t.every((t=>getFileIconState(t.idx).trash));let s="map-marker-other";r?s="map-marker-current":l&&(s="map-marker-trash");const c=L.divIcon({html:'<i class="fa-solid fa-location-dot"></i>',className:s,iconSize:[28,28],iconAnchor:[14,28]}),p=t.map((t=>t.file.name.replace(/\.wav$/i,""))),d=p.length<=5?p.join("<br>"):`${p[0]}<br>⋮<br>${p[p.length-1]}`,m=r?1e3:0,u=L.marker([a,i],{icon:c,zIndexOffset:m});u.on("click",(()=>{document.dispatchEvent(new CustomEvent("map-file-selected",{detail:{index:o.idx}}))})),u.bindTooltip(d,{direction:"top",offset:[-3,-32],className:"map-tooltip"}),u.addTo(h),v.push(u)})),mt()}function vt(){x.forEach((t=>t.remove())),x=[],w?.classList.remove("active"),w&&(w.innerHTML='<i class="fa-solid fa-eye"></i>')}function Lt(){D.forEach((t=>t.remove())),D=[]}async function Et(t){if(!t)return;const e=function(t){const e=(new DOMParser).parseFromString(t,"text/xml"),o=[],n=e.getElementsByTagName("LineString");for(let t=0;t<n.length;t++){const e=n[t].getElementsByTagName("coordinates")[0];if(!e)continue;const a=e.textContent.trim().split(/\s+/).map((t=>{const[e,o]=t.split(",").map(Number);return isNaN(o)||isNaN(e)?null:[o,e]})).filter(Boolean);a.length>1&&o.push(a)}return o}(await t.text());Lt();const o=[];e.forEach((t=>{const e=L.polyline(t,{color:"deeppink",weight:2,opacity:.8,renderer:L.canvas()}).addTo(h);D.push(e),o.push(...t)})),o.length>0&&(h.fitBounds(o),Ct())}function xt(){x.length>0?vt():(!function(){if(!h)return;vt();const t=getFileList(),e=[];t.forEach(((t,o)=>{const n=getFileMetadata(o),a=parseFloat(n.latitude),i=parseFloat(n.longitude),r=`${(n.date||"").replace(/\D/g,"")}${n.time||""}`;isNaN(a)||isNaN(i)||!r||e.push({lat:a,lon:i,ts:r})})),e.sort(((t,e)=>t.ts.localeCompare(e.ts)));let o=[],n=null;e.forEach((t=>{n&&h.distance([n.lat,n.lon],[t.lat,t.lon])>=1e3&&(o.length>1&&x.push(L.polyline(o,{color:"black",weight:2,opacity:.8,renderer:L.canvas()}).addTo(h)),o=[]),o.push([t.lat,t.lon]),n=t})),o.length>1&&x.push(L.polyline(o,{color:"black",weight:2,opacity:.8,renderer:L.canvas()}).addTo(h))}(),w?.classList.add("active"),w&&(w.innerHTML='<i class="fa-solid fa-eye-slash"></i>'))}function wt(){if(!B)return;!_&&z&&Mt(),_?(h.removeControl(B),C?.classList.remove("active"),_=!1):(B.addTo(h),C?.classList.add("active"),_=!0)}function Pt(){if(!h||!window.html2canvas)return;const t=h.getContainer(),e=t.querySelector(".leaflet-control-container"),o=[];e&&o.push(e),Y&&o.push(Y),o.forEach((t=>{t.style.display="none"})),html2canvas(t,{useCORS:!0}).then((t=>{o.forEach((t=>{t.style.display=""}));const e=document.createElement("a");e.href=t.toDataURL("image/png"),e.download="map.png",e.click()})).catch((()=>{o.forEach((t=>{t.style.display=""}))}))}function bt(t,e=!1){const o=e?' title="Left click to edit\nRight click to delete"':"";return L.divIcon({className:"map-text-icon",html:`<span class="map-text-label"${o}>${n=t,n.replace(/[&<>"]/g,(t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[t])))}</span>`,iconSize:null,iconAnchor:[0,0],popupAnchor:[0,0]});var n}function Dt(t){if(!h||H)return;const e=t.getLatLng(),o=h.latLngToContainerPoint(e),n=document.createElement("textarea");n.value=t.text||"",n.className="map-text-input",n.rows=1,n.style.left=`${o.x}px`,n.style.top=`${o.y}px`,h.getContainer().appendChild(n),H=n,h.dragging.disable(),n.focus();const a=()=>{n.style.height="auto",n.style.height=`${n.scrollHeight}px`};a(),n.addEventListener("input",a);const i=()=>{if(!H)return;const e=n.value.trim();h.getContainer().removeChild(n),H=null,h.dragging.enable(),e?(t.text=e,t.setIcon(bt(e,z))):(h.removeLayer(t),$=$.filter((e=>e!==t))),mt()};n.addEventListener("keydown",(t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),i())})),n.addEventListener("pointerdown",(t=>t.stopPropagation())),n.addEventListener("blur",(()=>{N=!0,setTimeout((()=>{document.activeElement!==n&&i()}))}))}function kt(t){if(N)return void(N=!1);if(H)return;const e=function(t,e){const o=L.marker(t,{icon:bt(e,z),draggable:z,pane:"annotationPane",zIndexOffset:1e3});return o.text=e,o.on("dblclick",(()=>{z&&Dt(o)})),o.on("click",(t=>{z&&!H&&(t.originalEvent.stopPropagation(),Dt(o))})),o.on("contextmenu",(t=>{if(!z||H)return;try{const e=t.originalEvent||t.srcEvent||{};e.preventDefault?.(),e.stopPropagation?.()}catch(t){}const e=document.createElement("button");e.style.position="absolute",e.style.left=(t.originalEvent?.clientX||0)+"px",e.style.top=(t.originalEvent?.clientY||0)+"px",e.style.width="1px",e.style.height="1px",e.style.padding="0",e.style.margin="0",e.style.opacity="0",e.style.zIndex="2147483647",e.style.pointerEvents="auto",document.body.appendChild(e);const n=new Dropdown(e,[{label:"Remove",value:"remove"}],{onChange:t=>{try{!t||"remove"!==t.value&&"Remove"!==t.label||(h.removeLayer(o),$=$.filter((t=>t!==o)),mt())}finally{a()}}});try{const t=n.menu.querySelector(".dropdown-item");t&&(t.style.color="red")}catch(t){}const a=()=>{try{n&&"function"==typeof n.close&&n.close()}catch(t){}try{n&&n.menu&&n.menu.parentNode&&n.menu.parentNode.removeChild(n.menu)}catch(t){}try{e&&e.parentNode&&e.parentNode.removeChild(e)}catch(t){}};try{const t=n.close.bind(n);n.close=function(){t(),a()}}catch(t){}n.open()})),o}(t.latlng,"");e.addTo(h),$.push(e),mt(),Dt(e)}function Mt(){const t=!z;t&&_&&wt(),z=t,S?.classList.toggle("active",z),z?h.on("click",kt):(h.off("click",kt),H&&H.blur()),$.forEach((t=>{z?t.dragging.enable():t.dragging.disable();const e=t.text||"";t.setIcon(bt(e,z)),t.setZIndexOffset(1e3)})),mt(),ut()}document.addEventListener("keydown",(t=>{"Control"!==t.key||pt||(pt=!0,mt())})),document.addEventListener("keyup",(t=>{"Control"===t.key&&pt&&(pt=!1,mt())})),i.addEventListener("dragenter",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),ct++,st&&(st.style.display="flex",st.style.pointerEvents="auto"),h?.dragging.disable())})),i.addEventListener("dragover",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),t.dataTransfer.dropEffect="copy")})),i.addEventListener("dragleave",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),ct--,ct<=0&&gt())})),i.addEventListener("drop",(async t=>{t.preventDefault(),ct=0,gt();const e=Array.from(t.dataTransfer.files).find((t=>t.name.endsWith(".kml")));e&&await Et(e)})),importKmlFileFn=Et,lt.addEventListener("change",(async()=>{const t=lt.files[0];t&&await Et(t)}));const Tt=13;function Ct(){const t=getCurrentIndex();if(t<0){ht(),yt();const t=getFileList(),e=[[21.8,113.8],[22.7,114.5]],o=[22.28552,114.15769];if(h||ft(o[0],o[1]),!t||0===t.length)try{h.fitBounds(e)}catch(t){h.setView(o,Tt)}return void(navigator.geolocation&&navigator.geolocation.getCurrentPosition((t=>{const{latitude:e,longitude:o}=t.coords,n=L.divIcon({html:'<i class="fa-solid fa-location-arrow"></i>',className:"map-marker-device",iconSize:[28,28],iconAnchor:[14,28]});h?h.setView([e,o]):ft(e,o);const a=L.marker([e,o],{icon:n,zIndexOffset:1001});a.addTo(h),v.push(a),mt()})))}const e=getFileMetadata(t),o=parseFloat(e.latitude),n=parseFloat(e.longitude);if(isNaN(o)||isNaN(n))return ht(),void(j&&(j.style.display="flex"));yt(),h?"block"!==a.style.display?h.setView([o,n],Tt):h.setView([o,n]):ft(o,n),ht()}function St(){"block"===a.style.display?(Xt&&It(),Yt&&Ft(),a.style.display="none",document.body.classList.remove("map-open"),z&&Mt()):(a.style.display="block",document.body.classList.add("map-open"),a.style.width=`${y}px`,a.style.height=`${f}px`,h&&h.invalidateSize(),Ct(),ut())}function It(){Xt?(a.style.width=`${Vt.width}px`,a.style.height=`${Vt.height}px`,a.style.left=`${Vt.left}px`,a.style.top=`${Vt.top}px`,d.innerHTML='<i class="fa-solid fa-window-minimize"></i>',d.title="Minimize",m.innerHTML='<i class="fa-regular fa-square"></i>',m.title="Maximize",Xt=!1):(Yt?(ot&&(ot.style.display=""),nt&&(nt.style.display=""),at&&(at.style.display=""),it&&(it.style.display=""),Y&&(Y.style.display=""),rt&&rt.style.setProperty("margin-top","1px","important"),Yt=!1):(Vt.width=a.offsetWidth,Vt.height=a.offsetHeight,Vt.left=a.offsetLeft,Vt.top=a.offsetTop,localStorage.setItem("mapFloatingWidth",Vt.width),localStorage.setItem("mapFloatingHeight",Vt.height),localStorage.setItem("mapFloatingLeft",Vt.left),localStorage.setItem("mapFloatingTop",Vt.top)),a.style.left="0px",a.style.top="0px",a.style.width=window.innerWidth-2+"px",a.style.height=window.innerHeight-2+"px",d.innerHTML='<i class="fa-solid fa-window-minimize"></i>',d.title="Minimize",m.innerHTML='<i class="fa-regular fa-clone"></i>',m.title="Restore Down",Xt=!0),h?.invalidateSize()}function Ft(){Yt?(a.style.width=`${Vt.width}px`,a.style.height=`${Vt.height}px`,a.style.left=`${Vt.left}px`,a.style.top=`${Vt.top}px`,d.innerHTML='<i class="fa-solid fa-window-minimize"></i>',d.title="Minimize",m.innerHTML='<i class="fa-regular fa-square"></i>',m.title="Maximize",ot&&(ot.style.display=""),nt&&(nt.style.display=""),at&&(at.style.display=""),it&&(it.style.display=""),Y&&(Y.style.display=""),rt&&rt.style.setProperty("margin-top","1px","important"),I?.parentElement&&!W&&(I.parentElement.style.display=""),Yt=!1):(Xt||(Vt.width=a.offsetWidth,Vt.height=a.offsetHeight,Vt.left=a.offsetLeft,Vt.top=a.offsetTop,localStorage.setItem("mapFloatingWidth",Vt.width),localStorage.setItem("mapFloatingHeight",Vt.height),localStorage.setItem("mapFloatingLeft",Vt.left),localStorage.setItem("mapFloatingTop",Vt.top)),a.style.left="0px",a.style.top=window.innerHeight-362+"px",a.style.width="290px",a.style.height="360px",d.innerHTML='<i class="fa-solid fa-window-maximize"></i>',d.title="Restore Up",m.innerHTML='<i class="fa-regular fa-square"></i>',m.title="Maximize",ot&&(ot.style.display="none"),nt&&(nt.style.display="none"),at&&(at.style.display="none"),it&&(it.style.display="none"),Y&&(Y.style.display="none"),rt&&rt.style.setProperty("margin-top","10px","important"),I?.parentElement&&(I.parentElement.style.display="none"),Yt=!0,Xt=!1),h?.invalidateSize()}let zt=!1,$t=0,Ht=0,Nt=!1,Bt=!1,Ot=!1,_t=!1,Rt=!1,At=0,Ut=0,Wt=0,Gt=0,qt=0,Kt=0,Xt=!1,Yt=!1;const Zt=Math.max(0,Math.floor((window.innerWidth-y)/2)),jt=Math.max(0,Math.floor((window.innerHeight-f)/2));let Vt={width:parseInt(localStorage.getItem("mapFloatingWidth"),10)||y,height:parseInt(localStorage.getItem("mapFloatingHeight"),10)||f,left:parseInt(localStorage.getItem("mapFloatingLeft"),10)||Zt,top:parseInt(localStorage.getItem("mapFloatingTop"),10)||jt};try{a.style.left=`${Vt.left}px`,a.style.top=`${Vt.top}px`}catch(t){}function Jt(){r&&(r.style.pointerEvents="none",r.classList.remove("hide-cursor")),l&&(l.style.pointerEvents="none"),s&&(s.style.pointerEvents="none")}function Qt(){r&&(r.style.pointerEvents=""),l&&(l.style.pointerEvents=""),s&&(s.style.pointerEvents="")}c&&c.addEventListener("mousedown",(t=>{Xt||(zt=!0,$t=t.clientX-a.offsetLeft,Ht=t.clientY-a.offsetTop,h?.dragging.disable(),Jt(),document.dispatchEvent(new Event("hide-spectrogram-hover")),t.preventDefault(),t.stopPropagation())})),a.addEventListener("mousemove",(t=>{if(Xt)return;if(zt||Nt)return void t.stopPropagation();const e=g(u(t.clientX,t.clientY))||"default";a.style.cursor=e,"default"!==e?(i.style.cursor=e,document.body.style.cursor=e,Jt(),document.dispatchEvent(new Event("hide-spectrogram-hover")),t.stopPropagation()):(i.style.cursor="",document.body.style.cursor="",Qt(),ut())})),a.addEventListener("mousedown",(t=>{if(Xt)return;if(t.target===c||c.contains(t.target))return;const e=u(t.clientX,t.clientY);if(e.onLeft||e.onRight||e.onTop||e.onBottom){Nt=!0,Bt=e.onLeft,Ot=e.onRight,_t=e.onTop,Rt=e.onBottom;const o=g(e)||"default";a.style.cursor=o,i.style.cursor=o,document.body.style.cursor=o,Jt(),document.dispatchEvent(new Event("hide-spectrogram-hover")),At=t.clientX,Ut=t.clientY,Wt=a.offsetWidth,Gt=a.offsetHeight,qt=a.offsetLeft,Kt=a.offsetTop,h?.dragging.disable(),t.preventDefault(),t.stopPropagation()}})),document.addEventListener("mousemove",(t=>{if("block"!==a.style.display||Xt)return;if(zt||Nt)return void t.stopPropagation();const e=g(u(t.clientX,t.clientY));e?(document.body.style.cursor=e,i.style.cursor=e,Jt(),document.dispatchEvent(new Event("hide-spectrogram-hover")),t.stopPropagation()):(document.body.style.cursor="",i.style.cursor="",Qt(),ut())}),!0),document.addEventListener("mousedown",(t=>{if("block"!==a.style.display||Xt)return;if(zt||Nt)return t.stopPropagation(),void t.preventDefault();if(t.target===c||c.contains(t.target))return;const e=u(t.clientX,t.clientY);if(e.onLeft||e.onRight||e.onTop||e.onBottom){Nt=!0,Bt=e.onLeft,Ot=e.onRight,_t=e.onTop,Rt=e.onBottom;const o=g(e)||"default";a.style.cursor=o,i.style.cursor=o,document.body.style.cursor=o,Jt(),document.dispatchEvent(new Event("hide-spectrogram-hover")),At=t.clientX,Ut=t.clientY,Wt=a.offsetWidth,Gt=a.offsetHeight,qt=a.offsetLeft,Kt=a.offsetTop,h?.dragging.disable(),t.preventDefault(),t.stopPropagation()}}),!0),window.addEventListener("mousemove",(t=>{if(!Xt){if(zt){const e=a.offsetWidth,o=a.offsetHeight;let n=t.clientX-$t,i=t.clientY-Ht;return n=Math.max(0,n),i=Math.max(0,i),n=Math.min(window.innerWidth-e,n),i=Math.min(window.innerHeight-o,i),a.style.left=`${n}px`,a.style.top=`${i}px`,void t.stopPropagation()}if(Nt){const e=t.clientX-At,o=t.clientY-Ut;i.style.cursor=a.style.cursor,document.body.style.cursor=a.style.cursor,Jt(),document.dispatchEvent(new Event("hide-spectrogram-hover")),Ot&&(y=Math.max(200,Wt+e),a.style.width=`${y}px`),Rt&&(f=Math.max(200,Gt+o),a.style.height=`${f}px`),Bt&&(y=Math.max(200,Wt-e),a.style.width=`${y}px`,a.style.left=`${qt+e}px`),_t&&(f=Math.max(200,Gt-o),a.style.height=`${f}px`,a.style.top=`${Kt+o}px`),t.stopPropagation()}}}),!0),window.addEventListener("mouseup",(t=>{Xt||(zt&&(zt=!1,h?.dragging.enable(),Qt(),t.stopPropagation()),Nt&&(Nt=!1,h?.dragging.enable(),Yt||Xt||(Vt.width=a.offsetWidth,Vt.height=a.offsetHeight,Vt.left=a.offsetLeft,Vt.top=a.offsetTop,localStorage.setItem("mapFloatingWidth",Vt.width),localStorage.setItem("mapFloatingHeight",Vt.height),localStorage.setItem("mapFloatingLeft",Vt.left),localStorage.setItem("mapFloatingTop",Vt.top)),h?.invalidateSize(),document.body.style.cursor="",a.style.cursor="",i.style.cursor="",Qt(),ut(),t.stopPropagation()))}),!0),n.addEventListener("click",St),m?.addEventListener("click",It),d?.addEventListener("click",Ft),p&&p.addEventListener("click",St),window.addEventListener("resize",(()=>{Xt?(a.style.width=window.innerWidth-2+"px",a.style.height=window.innerHeight-2+"px",h?.invalidateSize()):Yt&&(a.style.top=window.innerHeight-362+"px")})),document.addEventListener("file-loaded",Ct),document.addEventListener("file-list-cleared",(()=>ht())),document.addEventListener("file-list-changed",(()=>ht())),document.addEventListener("file-icon-toggled",(()=>ht()))}export async function importKmlFile(t){importKmlFileFn&&t&&await importKmlFileFn(t)}