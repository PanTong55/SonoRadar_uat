let canvas,ctx,sampleRate=44100,windowCache=new Map,twiddleFactorCache=new Map;function renderSpectrogram(t,e,a,o){const n=Math.max(1,Math.floor(a*(1-o/100))),c=Math.max(1,Math.ceil((t.length-a)/n)),r=a/2;canvas.width=c,canvas.height=r;const s=ctx.createImageData(c,r),l=s.data,h=getWindowCached(a),d=new Float32Array(a),f=new Float32Array(a),i=getTwiddleFactorsCached(a);for(let e=0,o=0;o+a<=t.length;o+=n,e++){for(let e=0;e<a;e++)d[e]=t[o+e]*h[e],f[e]=0;fftOptimized(d,f,i);for(let t=0;t<r;t++){const a=d[t]*d[t]+f[t]*f[t],o=Math.sqrt(a);let n=o>1e-12?Math.log10(o)/5:-2.4;n=n<0?0:n>1?1:n;const s=Math.floor(255*n),h=4*((r-1-t)*c+e);l[h]=s,l[h+1]=s,l[h+2]=s,l[h+3]=255}}ctx.putImageData(s,0,0),self.postMessage({type:"rendered"})}function getWindowCached(t){return windowCache.has(t)||windowCache.set(t,hannWindow(t)),windowCache.get(t)}function getTwiddleFactorsCached(t){if(!twiddleFactorCache.has(t)){const e=new Array(Math.log2(t));for(let a=0;a<Math.log2(t);a++){const t=1<<a+1,o=t>>1;e[a]=[];for(let n=0;n<o;n++){const o=-2*Math.PI*n/t;e[a][n]={c:Math.cos(o),s:Math.sin(o)}}}twiddleFactorCache.set(t,e)}return twiddleFactorCache.get(t)}function hannWindow(t){const e=new Float32Array(t),a=1/(t-1),o=2*Math.PI;for(let n=0;n<t;n++)e[n]=.5*(1-Math.cos(o*n*a));return e}function fftOptimized(t,e,a){const o=t.length;let n=0;for(let a=1;a<o-1;a++){let c=o>>1;for(;n>=c;)n-=c,c>>=1;if(n+=c,n>a){let o=t[a];t[a]=t[n],t[n]=o,o=e[a],e[a]=e[n],e[n]=o}}for(let n=0;n<a.length;n++){const c=a[n],r=1<<n+1,s=r>>1;for(let a=0;a<s;a++){const{c:n,s:l}=c[a];for(let c=a;c<o;c+=r){const a=c+s,o=n*t[a]-l*e[a],r=n*e[a]+l*t[a];t[a]=t[c]-o,e[a]=e[c]-r,t[c]+=o,e[c]+=r}}}}function fft(t,e){const a=t.length;let o,n,c,r,s,l,h,d=0,f=0;for(f=1,d=0;f<a-1;f++){for(o=a>>1;d>=o;)d-=o,o>>=1;d+=o,f<d&&(l=t[f],t[f]=t[d],t[d]=l,l=e[f],e[f]=e[d],e[d]=l)}o=0,n=1;for(let i=0;i<Math.log2(a);i++)for(o=n,n<<=1,c=0,f=0;f<o;f++)for(r=Math.cos(-2*Math.PI*f/n),s=Math.sin(-2*Math.PI*f/n),d=f;d<a;d+=n){const a=d+o;l=r*t[a]-s*e[a],h=s*t[a]+r*e[a],t[a]=t[d]-l,e[a]=e[d]-h,t[d]+=l,e[d]+=h}}self.onmessage=t=>{const{type:e}=t.data;if("init"===e)canvas=t.data.canvas,sampleRate=t.data.sampleRate||sampleRate,ctx=canvas.getContext("2d");else if("render"===e){if(!ctx)return;renderSpectrogram(t.data.buffer,t.data.sampleRate||sampleRate,t.data.fftSize||1024,t.data.overlap||0)}};